<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Ê≠ØÁßëÊ≤ªÁôÇË®àÁîªÊõ∏„Ç∑„Çπ„ÉÜ„É†</title>
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px;
        }

        /* ÂàÜÂâ≤ÁîªÈù¢„É¨„Ç§„Ç¢„Ç¶„Éà */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        .left-panel {
            width: 40%;
            min-width: 300px;
            background-color: #f8f9fa;
            overflow-y: auto;
            border-right: 2px solid #ddd;
            position: relative;
        }

        .right-panel {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }

        /* ÂàÜÂâ≤Á∑ö„Éâ„É©„ÉÉ„Ç∞ */
        .split-divider {
            position: absolute;
            right: -5px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: col-resize;
            background-color: transparent;
            z-index: 100;
        }

        .split-divider:hover {
            background-color: rgba(33, 150, 243, 0.3);
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .panel-header {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-navigation {
            display: flex;
            background-color: #f5f5f5;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 60px;
            z-index: 40;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background-color: #e0e0e0;
        }

        .tab-btn.active {
            color: #2196F3;
            background-color: white;
            border-bottom-color: #2196F3;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* „Éó„É©„É≥„Çø„Éñ */
        .plan-tabs {
            display: flex;
            gap: 5px;
            padding: 10px;
            background-color: #fafafa;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }

        .plan-tab {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .plan-tab:hover {
            background-color: #f5f5f5;
        }

        .plan-tab.active {
            background-color: #fff;
            border-bottom-color: white;
            position: relative;
            z-index: 1;
        }

        .plan-tab.ideal {
            border-top: 3px solid #FFD700;
        }

        .plan-tab.standard {
            border-top: 3px solid #2196F3;
        }

        .plan-tab.insurance {
            border-top: 3px solid #4CAF50;
        }

        .plan-tab.custom {
            border-top: 3px solid #9E9E9E;
        }

        .add-plan-btn {
            padding: 8px 16px;
            border: 1px dashed #999;
            background-color: transparent;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
            color: #666;
        }

        .add-plan-btn:hover {
            background-color: #f5f5f5;
            border-color: #666;
        }

        /* „Çª„ÇØ„Ç∑„Éß„É≥ */
        .section {
            margin: 15px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ */
        .accordion {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-header {
            background-color: #f5f5f5;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .accordion-header:hover {
            background-color: #e0e0e0;
        }

        .accordion-header.active {
            background-color: #e3f2fd;
            border-bottom: 1px solid #ddd;
        }

        .accordion-icon {
            transition: transform 0.3s;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: 20px;
            background-color: white;
        }

        .accordion-content.active {
            display: block;
        }

        /* „Ç¨„Ç§„Éâ„Éï„Ç©„Éº„É†Ë¶ÅÁ¥† */
        .guide-question {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .guide-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .guide-checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .guide-checkbox-item input[type="checkbox"] {
            margin-top: 3px;
        }

        .guide-checkbox-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guide-detail-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .guide-radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .guide-radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .guide-tooth-selection {
            margin: 15px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .guide-tooth-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .guide-tooth-btn:hover {
            background-color: #1976D2;
        }

        .selected-teeth-display {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 40px;
        }

        .tooth-item {
            display: inline-block;
            background-color: #e3f2fd;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
        }

        .tooth-item-reason {
            margin-left: 5px;
            color: #666;
            font-size: 11px;
        }

        .guide-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .transfer-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 20px auto;
            display: block;
        }

        .transfer-btn:hover {
            background-color: #45a049;
        }

        /* ÁîªÂÉè„ÇÆ„É£„É©„É™„Éº */
        .image-gallery {
            padding: 15px;
        }

        .gallery-view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .view-mode-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .view-mode-btn.active {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .gallery-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .gallery-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
            position: relative;
        }

        .gallery-section.drag-over {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }

        .gallery-section h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 400px;
        }

        .split-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background-color: white;
            overflow-y: auto;
        }

        /* ‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥ */
        .bulk-upload-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .bulk-upload-btn:hover {
            background-color: #45a049;
        }

        /* „Çµ„É†„Éç„Ç§„É´Ë°®Á§∫ */
        .thumbnail-grid {
            display: grid;
            gap: 10px;
        }

        .thumbnail-grid.intraoral {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            max-width: 495px;
            margin: 0 auto;
        }

        .thumbnail-grid.xray-bw {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .thumbnail-grid.dental-10 {
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .thumbnail {
            position: relative;
            aspect-ratio: 4/3;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px dashed #ccc;
        }

        /* Âè£ËÖîÂÜÖÂÜôÁúü„ÅÆÈÖçÁΩÆ */
        .thumbnail.intraoral-upper {
            grid-column: 2;
            grid-row: 1;
        }

        .thumbnail.intraoral-right {
            grid-column: 1;
            grid-row: 2;
        }

        .thumbnail.intraoral-front {
            grid-column: 2;
            grid-row: 2;
        }

        .thumbnail.intraoral-left {
            grid-column: 3;
            grid-row: 2;
        }

        .thumbnail.intraoral-lower {
            grid-column: 2;
            grid-row: 3;
        }

        /* „Éá„É≥„Çø„É´10ÊûöÊ≥ï„ÅÆÁ∏¶Âûã */
        .thumbnail.dental-portrait {
            aspect-ratio: 3/4;
        }

        .thumbnail.large {
            grid-column: span 2;
            aspect-ratio: 2/1;
        }

        .thumbnail.perio {
            grid-column: span 2;
            aspect-ratio: 2/1;
        }

        .thumbnail.has-image {
            border-style: solid;
            border-color: #ddd;
            cursor: move;
        }

        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .thumbnail.drag-over {
            border-color: #2196F3;
            background-color: #e3f2fd;
            transform: scale(1.1);
        }

        .thumbnail.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            user-select: none;
        }

        .thumbnail-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px;
            font-size: 11px;
            text-align: center;
            pointer-events: none;
        }

        /* ÁîªÂÉèÁ∑®ÈõÜ„Éú„Çø„É≥ */
        .image-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 3px;
            flex-direction: column;
            z-index: 10;
        }

        .thumbnail.has-image:hover .image-controls {
            display: flex;
        }

        .image-control-btn {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 3px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .image-control-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .image-control-btn.delete {
            background-color: rgba(244, 67, 54, 0.9);
        }

        .image-control-btn.delete:hover {
            background-color: rgba(244, 67, 54, 1);
        }

        /* Â§ß„Åç„ÅÑÁîªÂÉèË°®Á§∫ */
        .large-image-viewer {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            min-height: 200px;
        }

        .large-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆ„Éí„É≥„Éà */
        .drop-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        .gallery-section.drag-over .drop-hint {
            display: block;
        }

        /* ÊÇ£ËÄÖÊÉÖÂ†±„Éï„Ç©„Éº„É† */
        .patient-info-form {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Ê≤ªÁôÇË®àÁîª„Éò„ÉÉ„ÉÄ„Éº */
        .treatment-header {
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: -1px;
        }

        .header-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .header-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-input label {
            font-weight: bold;
            font-size: 13px;
            white-space: nowrap;
        }

        .header-input input {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .medical-buttons {
            display: flex;
            gap: 5px;
        }

        .medical-btn {
            padding: 5px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .medical-btn.selected {
            background-color: #ffcccc;
            border-color: #ff9999;
        }

        /* Ê≠ØÂºè„Éë„É¨„ÉÉ„Éà */
        .tooth-palette-container {
            position: sticky;
            top: 70px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 40;
            margin: 15px;
        }

        .current-selection {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #1976D2;
        }

        .tooth-chart {
            max-width: 500px;
            margin: 0 auto;
        }

        .tooth-chart-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            position: relative;
        }

        .cross-line-horizontal {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #333;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .cross-line-vertical {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #333;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .tooth-btn {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
            border-radius: 4px;
            padding: 0;
            min-height: 30px;
        }

        .tooth-btn:hover {
            background-color: #e3f2fd;
            border-color: #2196F3;
            transform: scale(1.1);
        }

        .tooth-btn.selected {
            background-color: #ffeb3b;
            border-color: #f57f17;
        }

        .tooth-divider {
            grid-column: 1 / -1;
            height: 20px;
            position: relative;
        }

        /* Ê≤ªÁôÇË®àÁîªË°® */
        .treatment-table {
            width: 100%;
            border-collapse: collapse;
        }

        .treatment-table th,
        .treatment-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }

        .treatment-table th {
            background-color: #f5f5f5;
            font-weight: normal;
        }

        .treatment-cell {
            text-align: center;
            font-weight: bold;
        }

        .treatment-cell.long-text {
            font-size: 11px;
        }

        .treatment-field {
            cursor: pointer;
            min-height: 50px;
            padding: 5px;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            background-color: #fafafa;
        }

        .treatment-field:hover {
            background-color: #f0f0f0;
            border-color: #ddd;
        }

        .treatment-field.active {
            border-color: #2196F3;
            background-color: #e3f2fd;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }

        .custom-field-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .free-text-area {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 40px;
        }

        .ng-text-input,
        .multi-line-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 40px;
        }

        /* ÂçÅÂ≠óË°®Á§∫ */
        .cross-display {
            display: inline-block;
            width: 80px;
            height: 50px;
            position: relative;
            margin: 2px;
            border: 1px solid #999;
        }

        .cross-display::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #333;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .cross-display::after {
            content: "";
            position: absolute;
            width: 1px;
            height: 100%;
            background-color: #333;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }

        .quadrant {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .quadrant.top-right { top: 0; right: 0; }
        .quadrant.top-left { top: 0; left: 0; }
        .quadrant.bottom-right { bottom: 0; right: 0; }
        .quadrant.bottom-left { bottom: 0; left: 0; }

        /* ÁâπÂà•„Å™Ê≤ªÁôÇÈ†ÖÁõÆ */
        .special-treatments {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .special-treatment-item {
            flex: 1;
            text-align: center;
        }

        .special-treatment-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }

        /* ÂÇôËÄÉÊ¨Ñ */
        .remarks-section {
            padding: 10px;
            font-size: 12px;
        }

        .patient-info-section {
            background-color: #f9f9f9;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .patient-info-section div {
            margin-bottom: 5px;
        }

        .patient-info-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 20px;
        }

        .remarks-row {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remarks-label {
            font-weight: bold;
            min-width: 70px;
            font-size: 12px;
        }

        .radio-group,
        .select-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .radio-group label,
        .select-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remarks-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .select-btn {
            padding: 4px 10px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .select-btn.selected {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }

        /* Ê≤ªÁôÇÈ†ÜÂ∫è */
        .treatment-order-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .auto-generate-section {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #2196F3;
        }

        .auto-generate-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-generate-btn:hover {
            background-color: #1976D2;
        }

        .treatment-order-item {
            display: grid;
            grid-template-columns: 30px 40px 200px 200px auto 100px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            cursor: move;
        }

        .treatment-order-item.dragging {
            opacity: 0.5;
        }

        .drag-handle {
            font-size: 18px;
            color: #666;
            cursor: grab;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .order-number {
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .treatment-select,
        .teeth-input,
        .notes-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .treatment-select:focus,
        .teeth-input:focus,
        .notes-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .delete-order-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-order-btn:hover {
            background-color: #d32f2f;
        }

        .add-order-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .add-order-btn:hover {
            background-color: #45a049;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background-color: #45a049;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-secondary {
            background-color: #9C27B0;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7B1FA2;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-warning {
            background-color: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #F57C00;
        }
         /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº */
        .action-bar {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background-color: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 80px;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        /* „Éï„Ç°„Ç§„É´„É™„Çπ„Éà */
        .file-item {
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fafafa;
        }

        .file-item:hover {
            background-color: #f5f5f5;
            border-color: #2196F3;
        }

        .file-item-info {
            flex: 1;
        }

        .file-item-actions {
            display: flex;
            gap: 10px;
        }

        /* Ê≠ØÂºèÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .tooth-selection-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .tooth-selection-content {
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .tooth-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tooth-selection-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .tooth-selection-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                height: calc(100vh - 80px);
            }
            
            .left-panel {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 2px solid #ddd;
            }
            
            .split-divider {
                display: none;
            }
            
            .treatment-order-item {
                grid-template-columns: 30px 40px 1fr;
                gap: 5px;
            }
            
            .treatment-select,
            .teeth-input,
            .notes-input,
            .delete-order-btn {
                grid-column: 3;
                margin-top: 5px;
            }
            
            .header-inputs {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: 100px;
            }
            
            .action-bar {
                height: 120px;
                flex-wrap: wrap;
                padding: 10px;
            }
            
            .thumbnail-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .btn {
                font-size: 11px;
                padding: 8px 12px;
            }
        }

        /* iPad„Çø„ÉÉ„ÉÅÊúÄÈÅ©Âåñ */
        @media (pointer: coarse) {
            .tooth-btn {
                min-height: 44px;
            }
            
            .btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            input, select, textarea {
                font-size: 16px;
            }
        }

        /* Âç∞Âà∑Áî®„Çπ„Çø„Ç§„É´ */
        @media print {
            .left-panel,
            .action-bar,
            .btn,
            .split-divider,
            .gallery-view-toggle,
            .image-controls {
                display: none !important;
            }
            
            .main-container {
                display: block;
            }
            
            .right-panel {
                width: 100%;
            }
            
            body {
                background: white;
                padding-bottom: 0;
            }
        }

        /* Ê≠ØÂºèÈÅ∏Êäû„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .tooth-btn {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .tooth-btn.drag-selecting {
            background-color: #bbdefb;
            border-color: #1976D2;
        }

        .tooth-chart.dragging {
            cursor: crosshair;
        }

        .selection-hint {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #1976D2;
        }

        /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº */
        .progress-bar {
            background-color: #f0f0f0;
            height: 4px;
            position: relative;
            margin-bottom: 20px;
        }

        .progress-fill {
            background-color: #2196F3;
            height: 100%;
            width: 0;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Â∑¶„Éë„Éç„É´ÔºöË®∫Êüª„Éá„Éº„Çø -->
        <div class="left-panel">
            <div class="split-divider"></div>
            
            <div class="panel-header">
                <h2>Ë®∫Êüª„Éá„Éº„Çø</h2>
            </div>
            
            <!-- ÊÇ£ËÄÖÊÉÖÂ†±ÔºàÁ∞°Á¥†ÂåñÔºâ -->
            <div class="section">
                <h3>ÊÇ£ËÄÖÂü∫Êú¨ÊÉÖÂ†±</h3>
                <div class="patient-info-form">
                    <div class="form-group">
                        <label>ÊÇ£ËÄÖÂêç <span style="color: red;">*</span></label>
                        <input type="text" id="patientName" placeholder="Â±±Áî∞ Â§™ÈÉé">
                    </div>
                    <div class="form-group">
                        <label>ÊÇ£ËÄÖID <span style="color: red;">*</span></label>
                        <input type="text" id="patientId" placeholder="12345">
                    </div>
                </div>
            </div>
                      
            <!-- ÁîªÂÉè„ÇÆ„É£„É©„É™„ÉºÔºàÊã°ÂºµÔºâ -->
            <div class="section">
                <h3>ÁîªÂÉè„ÉªÊ§úÊüª„Éá„Éº„Çø</h3>
                <div class="image-gallery">
                    <div class="gallery-view-toggle">
                        <span style="font-weight: bold;">Ë°®Á§∫„É¢„Éº„ÉâÔºö</span>
                        <button class="view-mode-btn active" onclick="setViewMode('single')">ÂçòÁã¨Ë°®Á§∫</button>
                        <button class="view-mode-btn" onclick="setViewMode('split')">ÂàÜÂâ≤Ë°®Á§∫</button>
                    </div>
                    
                    <!-- ÂçòÁã¨Ë°®Á§∫„É¢„Éº„Éâ -->
                    <div id="single-view" class="gallery-container">
                        <!-- Âè£ËÖîÂÜÖÂÜôÁúü -->
                        <div class="gallery-section" data-section-type="intraoral" data-max-images="5">
                            <h4>Âè£ËÖîÂÜÖÂÜôÁúü</h4>
                            <button class="bulk-upload-btn" onclick="bulkUploadIntraoral()">
                                <span>üì∑</span>
                                <span>5ÊûöÊ≥ï‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                            </button>
                            <div class="drop-hint">„Åì„Åì„Å´ÁîªÂÉè„Çí„Éâ„É≠„ÉÉ„ÉóÔºàÊúÄÂ§ß5ÊûöÔºâ</div>
                            <div class="thumbnail-grid intraoral" id="intraoral-thumbnails">
                                <div class="thumbnail intraoral-upper" data-type="intraoral" data-position="upper">
                                    <div class="thumbnail-label">‰∏äÈ°éÂí¨ÂêàÈù¢</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail intraoral-right" data-type="intraoral" data-position="right">
                                    <div class="thumbnail-label">Âè≥ÂÅ¥Èù¢Ë¶≥</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail intraoral-front" data-type="intraoral" data-position="front">
                                    <div class="thumbnail-label">Ê≠£Èù¢Ë¶≥</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail intraoral-left" data-type="intraoral" data-position="left">
                                    <div class="thumbnail-label">Â∑¶ÂÅ¥Èù¢Ë¶≥</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail intraoral-lower" data-type="intraoral" data-position="lower">
                                    <div class="thumbnail-label">‰∏ãÈ°éÂí¨ÂêàÈù¢</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- „É¨„É≥„Éà„Ç≤„É≥ -->
                        <div class="gallery-section">
                            <h4>„É¨„É≥„Éà„Ç≤„É≥</h4>
                            <div class="thumbnail-grid xray-bw" id="xray-thumbnails">
                                <div class="thumbnail large" data-type="xray" data-position="panorama">
                                    <div class="thumbnail-label">„Éë„Éé„É©„Éû</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail" data-type="xray" data-position="bw-right">
                                    <div class="thumbnail-label">Âè≥ÂÅ¥BW</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                                <div class="thumbnail" data-type="xray" data-position="bw-left">
                                    <div class="thumbnail-label">Â∑¶ÂÅ¥BW</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 15px;">„Éá„É≥„Çø„É´10ÊûöÊ≥ï</h4>
                            <div class="gallery-section" data-section-type="dental10" data-max-images="10" style="padding: 10px;">
                                <button class="bulk-upload-btn" onclick="bulkUploadDental10()">
                                    <span>ü¶∑</span>
                                    <span>10ÊûöÊ≥ï‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                                </button>
                                <div class="drop-hint">„Åì„Åì„Å´ÁîªÂÉè„Çí„Éâ„É≠„ÉÉ„ÉóÔºàÊúÄÂ§ß10ÊûöÔºâ</div>
                                <div class="thumbnail-grid dental-10">
                                    <div class="thumbnail" data-type="xray" data-position="10-1">
                                        <div class="thumbnail-label">1</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-2">
                                        <div class="thumbnail-label">2</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-3">
                                        <div class="thumbnail-label">3</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-4">
                                        <div class="thumbnail-label">4</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail" data-type="xray" data-position="10-5">
                                        <div class="thumbnail-label">5</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail" data-type="xray" data-position="10-6">
                                        <div class="thumbnail-label">6</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-7">
                                        <div class="thumbnail-label">7</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-8">
                                        <div class="thumbnail-label">8</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail dental-portrait" data-type="xray" data-position="10-9">
                                        <div class="thumbnail-label">9</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                    <div class="thumbnail" data-type="xray" data-position="10-10">
                                        <div class="thumbnail-label">10</div>
                                        <div class="image-controls">
                                            <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                            <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                            <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                            <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ê≠ØÂë®Ê§úÊüª -->
                        <div class="gallery-section">
                            <h4>Ê≠ØÂë®Ê§úÊüª</h4>
                            <div class="thumbnail-grid">
                                <div class="thumbnail perio" data-type="perio" data-position="chart">
                                    <div class="thumbnail-label">Ê≠ØÂë®Ê§úÊüªË°®</div>
                                    <div class="image-controls">
                                        <button class="image-control-btn" onclick="flipImageVertical(event, this)" title="‰∏ä‰∏ãÂèçËª¢">‚Üï</button>
                                        <button class="image-control-btn" onclick="flipImageHorizontal(event, this)" title="Â∑¶Âè≥ÂèçËª¢">‚Üî</button>
                                        <button class="image-control-btn" onclick="rotateImage(event, this)" title="90Â∫¶ÂõûËª¢">‚Üª</button>
                                        <button class="image-control-btn delete" onclick="deleteImage(event, this)" title="ÂâäÈô§">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂàÜÂâ≤Ë°®Á§∫„É¢„Éº„Éâ -->
                    <div id="split-view" class="split-view" style="display: none;">
                        <div class="split-section">
                            <h4>Âè£ËÖîÂÜÖÂÜôÁúü</h4>
                            <div id="split-intraoral"></div>
                        </div>
                        <div class="split-section">
                            <h4>„É¨„É≥„Éà„Ç≤„É≥</h4>
                            <div id="split-xray"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Â§ß„Åç„ÅÑÁîªÂÉèË°®Á§∫„Ç®„É™„Ç¢ -->
                <div class="large-image-viewer" id="largeImageViewer">
                    <div id="largeImageContainer">
                        <p style="color: #999;">ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Âè≥„Éë„Éç„É´ÔºöÊ≤ªÁôÇË®àÁîª -->
        <div class="right-panel">
            <div class="panel-header">
                <h2>Ê≤ªÁôÇË®àÁîª„Ç∑„Çπ„ÉÜ„É†</h2>
            </div>
            
            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchMainTab('guide')">Ê≤ªÁôÇË®àÁîªÁ´ãÊ°à„Ç¨„Ç§„Éâ</button>
                <button class="tab-btn" onclick="switchMainTab('plan')">Ê≤ªÁôÇË®àÁîªË°®</button>
            </div>
            
            <!-- Ê≤ªÁôÇË®àÁîªÁ´ãÊ°à„Ç¨„Ç§„Éâ„Çø„Éñ -->
            <div id="guide-tab" class="tab-content active">
                <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0% ÂÆå‰∫Ü</div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥1ÔºöÊÇ£ËÄÖËÉåÊôØ„ÅÆË©ï‰æ° -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>1. ÊÇ£ËÄÖËÉåÊôØ„ÅÆË©ï‰æ°</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÁèæÂú®„ÅÆÊÇ£ËÄÖ„Åï„Çì„ÅÆÁä∂ÊÖã„ÅßËÄÉÊÖÆ„Åó„Å¶„Åä„Åè„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</div>
                        <div class="guide-checkbox-group">
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="consider-period" onchange="updateProgress()">
                                <div class="guide-checkbox-label">
                                    <label for="consider-period">Ê≤ªÁôÇÊúüÈñì„ÅÆÂà∂Á¥Ñ„ÅÇ„Çä</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="consider-age" onchange="updateProgress()">
                                <div class="guide-checkbox-label">
                                    <label for="consider-age">Âπ¥ÈΩ¢ÁöÑ„Å™ÈÖçÊÖÆÂøÖË¶Å</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="consider-medical" onchange="updateProgress()">
                                <div class="guide-checkbox-label">
                                    <label for="consider-medical">ÂÖ®Ë∫´ÁñæÊÇ£„ÉªÊó¢ÂæÄÊ≠¥„ÅÇ„Çä</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="consider-work" onchange="updateProgress()">
                                <div class="guide-checkbox-label">
                                    <label for="consider-work">‰ªï‰∫ãÂÜÖÂÆπ„ÅÆÈÖçÊÖÆÂøÖË¶Å</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="consider-other" onchange="updateProgress()">
                                <div class="guide-checkbox-label">
                                    <label for="consider-other">„Åù„ÅÆ‰ªñ</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥2ÔºöÊäúÊ≠ØÈÅ©ÂøúÊ≠Ø„ÅÆË©ï‰æ° -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>2. ÊäúÊ≠ØÈÅ©ÂøúÊ≠Ø„ÅÆË©ï‰æ°</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÁèæÁä∂ÊäúÊ≠Ø„ÅåÂøÖË¶Å„Å™Ê≠Ø„ÅØÔºü</div>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('extraction')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="extraction-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥3Ôºö‰∫àÂæå‰∏çËâØÊ≠Ø„ÅÆË©ï‰æ° -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>3. ‰∫àÂæå‰∏çËâØÊ≠Ø„ÅÆË©ï‰æ°Ôºà3Âπ¥‰ª•ÂÜÖÔºâ</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">3Âπ¥‰ª•ÂÜÖ„Å´Ê≠ØÂë®ÁóÖ„ÇÑÁ†¥Êäò„ÅßÊäúÊ≠Ø„Å´„Å™„Çä„Åù„ÅÜ„Å™Ê≠Ø„ÅØÔºü</div>
                        <div class="guide-checkbox-group">
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="risk-vital">
                                <label for="risk-vital">Â§±Ê¥ªÊ≠Ø</label>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="risk-apical">
                                <label for="risk-apical">Ê†πÂ∞ñÁóÖÂ∑£</label>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="risk-crown">
                                <label for="risk-crown">Ê≠ØÂÜ†Ê≠ØÊ†πÊØî‰∏çËâØ</label>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="risk-pocket">
                                <label for="risk-pocket">„Éù„Ç±„ÉÉ„Éà„ÅåÊ∑±„ÅÑ</label>
                            </div>
                        </div>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('prognosis')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="prognosis-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥4ÔºöÂí¨ÂêàÂπ≥Èù¢„ÅÆË©ï‰æ° -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>4. Âí¨ÂêàÂπ≥Èù¢„ÅÆË©ï‰æ°</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">Âí¨ÂêàÂπ≥Èù¢„ÅÆ„Ç∫„É¨„ÇíÊ≤ª„ÅôÈÉ®ÂàÜ„ÅØ„ÅÇ„Çã„ÅãÔºü</div>
                        <div class="guide-checkbox-group">
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="occlusal-extrusion">
                                <label for="occlusal-extrusion">Êå∫Âá∫„Åó„Å¶„ÅÑ„ÇãÊ≠Ø„Åå„ÅÇ„Çã</label>
                                <button class="btn btn-sm" onclick="openToothSelection('extrusion')" style="margin-left: 10px;">Ê≠ØÂºèÈÅ∏Êäû</button>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="occlusal-plane">
                                <div class="guide-checkbox-label">
                                    <label for="occlusal-plane">Â∑¶Âè≥„ÅÆÂπ≥Èù¢„Åå„Ç∫„É¨„Å¶„ÅÑ„Çã</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="occlusal-wear">
                                <label for="occlusal-wear">Ê•µÁ´Ø„Å´Âí¨ËÄó„Åó„Å¶„ÅÑ„Çã</label>
                                <button class="btn btn-sm" onclick="openToothSelection('wear')" style="margin-left: 10px;">Ê≠ØÂºèÈÅ∏Êäû</button>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="occlusal-tmd">
                                <div class="guide-checkbox-label">
                                    <label for="occlusal-tmd">TMD„Åå„ÅÇ„Çã</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë©≥Á¥∞„ÇíÂÖ•Âäõ">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥5ÔºöÂí¨ÂêàÁä∂Ê≥Å„ÅÆÂàÜÈ°û -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>5. Âí¨ÂêàÁä∂Ê≥Å„ÅÆÂàÜÈ°û</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÁèæÂú®„ÅÆÂí¨ÂêàÁä∂Ê≥Å„ÅØÔºü</div>
                        <div class="guide-radio-group">
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-1" value="1Á¥ö">
                                <label for="class-1">1Á¥ö</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-2" value="2Á¥ö">
                                <label for="class-2">2Á¥ö</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-3" value="3Á¥ö">
                                <label for="class-3">3Á¥ö</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-open" value="„Ç™„Éº„Éó„É≥„Éê„Ç§„Éà">
                                <label for="class-open">„Ç™„Éº„Éó„É≥„Éê„Ç§„Éà</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-deep" value="„Éá„Ç£„Éº„Éó„Éê„Ç§„Éà">
                                <label for="class-deep">„Éá„Ç£„Éº„Éó„Éê„Ç§„Éà</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-scissors" value="„Ç∑„Ç∂„Éº„Ç∫„Éê„Ç§„Éà">
                                <label for="class-scissors">„Ç∑„Ç∂„Éº„Ç∫„Éê„Ç§„Éà</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="occlusion-class" id="class-other" value="„Åù„ÅÆ‰ªñ">
                                <label for="class-other">„Åù„ÅÆ‰ªñ</label>
                            </div>
                        </div>
                        <input type="text" class="guide-detail-input" id="occlusion-other-detail" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØË©≥Á¥∞„ÇíÂÖ•Âäõ" style="margin-top: 10px; display: none;">
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥6Ôºö‰øùÈô∫Ê≤ªÁôÇ„Åß„ÅÆË®àÁîª -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>6. ‰øùÈô∫Ê≤ªÁôÇ„Åß„ÅÆË®àÁîª</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÂÖ®„Å¶„Çí‰øùÈô∫Ê≤ªÁôÇ„ÅßÊ≤ª„Åô„Å®„Åó„Å¶„Åæ„ÅöË®àÁîª</div>
                        
                        <h4>„Ç´„É™„Ç®„Çπ„Åå„ÅÇ„ÇãÊ≠Ø„ÅØÔºü</h4>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('caries')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="caries-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="need-pulpectomy">
                                <label for="need-pulpectomy">ÊäúÈ´Ñ„ÅåÂøÖË¶Å„Å™Ê≠Ø„Åå„ÅÇ„Çã</label>
                                <button class="btn btn-sm" onclick="openToothSelection('pulpectomy')" style="margin-left: 10px;">Ë©≤ÂΩìÊ≠Ø„ÇíÈÅ∏Êäû</button>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px;">‰∏çËâØË£úÁ∂¥Áâ©„ÅØÔºü</h4>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('poor-prosthesis')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="poor-prosthesis-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px;">Ê†πÁÆ°Ê≤ªÁôÇ„ÅåÂøÖË¶Å„Å™ÈÉ®‰Ωç</h4>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('endo')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="endo-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px;">Ê¨†Êêç„Åå„ÅÇ„ÇãÂ†¥Âêà</h4>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('missing')">Ê¨†ÊêçÈÉ®‰Ωç„ÇíÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="missing-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background-color: #f5f5f5; border-radius: 4px;">
                            <div class="guide-radio-group">
                                <div class="guide-radio-item">
                                    <input type="radio" name="prosthesis-type" id="bridge" value="bridge">
                                    <label for="bridge">„Éñ„É™„ÉÉ„Ç∏</label>
                                </div>
                                <div class="guide-radio-item">
                                    <input type="radio" name="prosthesis-type" id="denture" value="denture">
                                    <label for="denture">Áæ©Ê≠Ø</label>
                                </div>
                            </div>
                            
                            <div id="bridge-options" style="display: none; margin-top: 15px;">
                                <div>
                                    <label>ÊîØÂè∞Ê≠Ø„ÅØÂâçÂæå„ÅÆÊ≠Ø„Å†„Åë„ÅßÂ§ß‰∏àÂ§´„ÅãÔºü</label>
                                    <div class="guide-radio-group">
                                        <label><input type="radio" name="abutment-sufficient" value="yes"> „ÅØ„ÅÑ</label>
                                        <label><input type="radio" name="abutment-sufficient" value="no"> „ÅÑ„ÅÑ„Åà</label>
                                        <label><input type="radio" name="abutment-sufficient" value="consider"> Ë¶ÅÊ§úË®é</label>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-sm" onclick="openToothSelection('additional-abutment')">ËøΩÂä†ÊîØÂè∞Ê≠Ø„ÇíÈÅ∏Êäû</button>
                                </div>
                            </div>
                            
                            <div id="denture-options" style="display: none; margin-top: 15px;">
                                <div>
                                    <label>Ë®≠Ë®à„É°„É¢Ôºö</label>
                                    <textarea class="guide-textarea" placeholder="Áæ©Ê≠Ø„ÅÆË®≠Ë®à„Å´„Å§„ÅÑ„Å¶Ë®òÂÖ•"></textarea>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-sm" onclick="openToothSelection('clasp')">Èâ§Ê≠Ø„ÇíÈÅ∏Êäû</button>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label><input type="checkbox" id="clasp-redo"> Èâ§Ê≠Ø„ÅÆ„ÇÑ„ÇäÁõ¥„Åó„ÅåÂøÖË¶Å</label>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label><input type="checkbox" id="clasp-splint"> „ÇØ„É©„Çπ„Éó„Çí„Åã„Åë„ÇãÊ≠Ø„ÅÆÈÄ£Áµê„ÅåÂøÖË¶Å</label>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label>Ê≥®ÊÑè‰∫ãÈ†ÖÔºö</label>
                                    <input type="text" class="guide-detail-input" placeholder="Ë£ÖÁùÄÊÑü„Çà„Çä„ÇÇÊ©üËÉΩ„ÇíÂÑ™ÂÖà„Å™„Å©">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥7ÔºöÁüØÊ≠£Ê≤ªÁôÇ„ÅÆÊ§úË®é -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>7. ÁüØÊ≠£Ê≤ªÁôÇ„ÅÆÊ§úË®é</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÁüØÊ≠£Ê≤ªÁôÇ„ÇíÁµÑ„ÅøÂÖ•„Çå„Çã„Åã</div>
                        <div class="guide-radio-group">
                            <div class="guide-radio-item">
                                <input type="radio" name="ortho-need" id="ortho-none" value="ÂøÖË¶Å„Å™„Åó">
                                <label for="ortho-none">ÂøÖË¶Å„Å™„Åó</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="ortho-need" id="ortho-no-hope" value="ÊÇ£ËÄÖÂ∏åÊúõ„Å™„Åó„ÄÅ„Åß„ÇÇÂøÖË¶Å">
                                <label for="ortho-no-hope">ÊÇ£ËÄÖÂ∏åÊúõ„Å™„Åó„ÄÅ„Åß„ÇÇÂøÖË¶Å</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="ortho-need" id="ortho-hope" value="ÊÇ£ËÄÖÂ∏åÊúõ„ÅÇ„Çä">
                                <label for="ortho-hope">ÊÇ£ËÄÖÂ∏åÊúõ„ÅÇ„Çä</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="ortho-need" id="ortho-must" value="Áµ∂ÂØæÂøÖË¶Å">
                                <label for="ortho-must">Áµ∂ÂØæÂøÖË¶Å</label>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>ÁüØÊ≠£„ÅÇ„Çä„ÅÆÂ†¥Âêà„ÅÆÂ§âÊõ¥ÁÇπÔºö</label>
                            <textarea class="guide-textarea" placeholder="ÁüØÊ≠£Ê≤ªÁôÇ„ÇíÁµÑ„ÅøÂÖ•„Çå„ÅüÂ†¥Âêà„ÅÆÊ≤ªÁôÇË®àÁîª„ÅÆÂ§âÊõ¥ÁÇπ"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥8Ôºö„Ç§„É≥„Éó„É©„É≥„ÉàË®àÁîª -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>8. „Ç§„É≥„Éó„É©„É≥„ÉàË®àÁîª</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">Ê¨†ÊêçÈÉ®„Å´„Ç§„É≥„Éó„É©„É≥„Éà„ÇíË®àÁîª„Åô„Çã</div>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('implant-plan')">„Ç§„É≥„Éó„É©„É≥„ÉàÂüãÂÖ•‰∫àÂÆöÈÉ®‰Ωç</button>
                            <div class="selected-teeth-display" id="implant-plan-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h4>„Ç§„É≥„Éó„É©„É≥„ÉàË®àÁîª„ÅÆËÄÉ„ÅàÊñπÔºö</h4>
                            <div class="guide-checkbox-group">
                                <div class="guide-checkbox-item">
                                    <input type="checkbox" id="implant-reduce-denture">
                                    <label for="implant-reduce-denture">ÂÖ•„ÇåÊ≠Ø„ÅåÂ∞è„Åï„Åè„Å™„Çã</label>
                                </div>
                                <div class="guide-checkbox-item">
                                    <input type="checkbox" id="implant-no-denture">
                                    <label for="implant-no-denture">ÂÖ•„ÇåÊ≠Ø„Åå„Å™„Åè„Å™„Çã</label>
                                </div>
                                <div class="guide-checkbox-item">
                                    <input type="checkbox" id="implant-with-denture">
                                    <label for="implant-with-denture">„Ç§„É≥„Éó„É©„É≥„Éà‰ΩµÁî®Áæ©Ê≠Ø</label>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h4>ÊÆµÈöéÁöÑË®àÁîªÔºö</h4>
                            <div style="margin-bottom: 10px;">
                                <label>ÂÖ®„Å¶ÂÖ•„Çå„ÅüÂ†¥ÂêàÔºö</label>
                                <button class="btn btn-sm" onclick="openToothSelection('implant-all')">Ê≠ØÂºèÈÅ∏Êäû</button>
                                <input type="number" placeholder="Êú¨Êï∞" style="width: 80px; margin-left: 10px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label>ÊúÄÂ∞èÈôê„ÅÆÂ†¥ÂêàÔºö</label>
                                <button class="btn btn-sm" onclick="openToothSelection('implant-min')">Ê≠ØÂºèÈÅ∏Êäû</button>
                                <input type="number" placeholder="Êú¨Êï∞" style="width: 80px; margin-left: 10px;">
                            </div>
                            <div>
                                <label>Êé®Â•®„Éó„É©„É≥Ôºö</label>
                                <button class="btn btn-sm" onclick="openToothSelection('implant-recommend')">Ê≠ØÂºèÈÅ∏Êäû</button>
                                <input type="number" placeholder="Êú¨Êï∞" style="width: 80px; margin-left: 10px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥9ÔºöÂ∞ÜÊù•ÁöÑ„Å™ËøΩÂä†Ê≤ªÁôÇ„ÅÆ‰∫àÊ∏¨ -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>9. Â∞ÜÊù•ÁöÑ„Å™ËøΩÂä†Ê≤ªÁôÇ„ÅÆ‰∫àÊ∏¨</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">‰ªäÂõûÊ≤ªÁôÇ„Åó„Å¶„ÇÇÊï∞Âπ¥Âæå„Å´„Ç§„É≥„Éó„É©„É≥„Éà„ÅÆËøΩÂä†„ÅåÂÖ•„Çä„Åù„ÅÜ„Å™ÈÉ®‰Ωç„ÅØ„ÅÇ„Çã„ÅãÔºü</div>
                        <div class="guide-tooth-selection">
                            <button class="guide-tooth-btn" onclick="openToothSelection('future-implant')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="future-implant-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>ÁêÜÁî±Ôºö</label>
                            <textarea class="guide-textarea" placeholder="Â∞ÜÊù•ÁöÑ„Å´„Ç§„É≥„Éó„É©„É≥„Éà„ÅåÂøÖË¶Å„Å´„Å™„Çä„Åù„ÅÜ„Å™ÁêÜÁî±"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥10ÔºöËá™Ë≤ªÊ≤ªÁôÇ„Ç™„Éó„Ç∑„Éß„É≥ -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>10. Ëá™Ë≤ªÊ≤ªÁôÇ„Ç™„Éó„Ç∑„Éß„É≥</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <h4>Ëá™Ë≤ª„ÅÆÂÖ•„ÇåÊ≠Ø„ÅÆË®≠Ë®à„ÇÑÊùêË≥™„ÇíËÄÉ„Åà„Çã</h4>
                        <div class="guide-checkbox-group">
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="metal-base">
                                <label for="metal-base">ÈáëÂ±ûÂ∫ä</label>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="magnet">
                                <label for="magnet">„Éû„Ç∞„Éç„ÉÉ„Éà</label>
                                <button class="btn btn-sm" onclick="openToothSelection('magnet-teeth')" style="margin-left: 10px;">Ê≠ØÂºèÈÅ∏Êäû</button>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="non-cla
„Ç≥„Éî„Éº
3Ë°åÊàª„Å£„Å¶Á∂ö„Åç„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ
Copy                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="non-clasp">
                                <label for="non-clasp">„Éé„É≥„ÇØ„É©„Çπ„Éó</label>
                            </div>
                            <div class="guide-checkbox-item">
                                <input type="checkbox" id="other-denture">
                                <div class="guide-checkbox-label">
                                    <label for="other-denture">„Åù„ÅÆ‰ªñ</label>
                                    <input type="text" class="guide-detail-input" placeholder="„Åù„ÅÆ‰ªñ„ÅÆËá™Ë≤ª„Ç™„Éó„Ç∑„Éß„É≥">
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>‰øùÈô∫Áæ©Ê≠Ø„Çà„ÇäËá™Ë≤ªÁæ©Ê≠Ø„Çí„ÇÑ„Çã„Åì„Å®„ÅÆ„É°„É™„ÉÉ„Éà„ÅØÔºü</h4>
                            <textarea class="guide-textarea" placeholder="ÊÇ£ËÄÖÁõÆÁ∑ö„Åß„ÅÆ„É°„É™„ÉÉ„Éà„ÇíË®òÂÖ•"></textarea>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Ëá™Ë≤ªÁæ©Ê≠Ø„Å®„Ç§„É≥„Éó„É©„É≥„ÉàÊ≤ªÁôÇ„Å†„Å®„Å©„Å°„Çâ„Åå„É°„É™„ÉÉ„Éà„ÅÇ„Çä„Åù„ÅÜ„ÅãÔºü</h4>
                            <div class="guide-radio-group">
                                <div class="guide-radio-item">
                                    <input type="radio" name="denture-vs-implant" id="prefer-denture" value="Ëá™Ë≤ªÁæ©Ê≠Ø">
                                    <label for="prefer-denture">Ëá™Ë≤ªÁæ©Ê≠Ø</label>
                                </div>
                                <div class="guide-radio-item">
                                    <input type="radio" name="denture-vs-implant" id="prefer-implant" value="„Ç§„É≥„Éó„É©„É≥„Éà">
                                    <label for="prefer-implant">„Ç§„É≥„Éó„É©„É≥„Éà</label>
                                </div>
                                <div class="guide-radio-item">
                                    <input type="radio" name="denture-vs-implant" id="case-by-case" value="„Ç±„Éº„Çπ„Éê„Ç§„Ç±„Éº„Çπ">
                                    <label for="case-by-case">„Ç±„Éº„Çπ„Éê„Ç§„Ç±„Éº„Çπ</label>
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <label>ÁêÜÁî±Ôºö</label>
                                <textarea class="guide-textarea" placeholder="ÈÅ∏Êäû„ÅÆÁêÜÁî±„ÇíË®òÂÖ•"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥11ÔºöÈï∑Êúü‰∫àÂæå„ÅÆË©ï‰æ° -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>11. Èï∑Êúü‰∫àÂæå„ÅÆË©ï‰æ°</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <h4>5Âπ¥-10Âπ¥„ÅßÂøÉÈÖç„Å™ÈÉ®ÂàÜ</h4>
                        <div style="margin-bottom: 15px;">
                            <label>Âè£ËÖîÂÜÖÂÖ®‰ΩìÔºö</label>
                            <textarea class="guide-textarea" placeholder="ÂÖ®‰ΩìÁöÑ„Å™Êá∏Âøµ‰∫ãÈ†Ö"></textarea>
                        </div>
                        
                        <div>
                            <label>ÂÖ∑‰ΩìÁöÑ„Å™ÂøÉÈÖç„Å™Ê≠ØÔºö</label>
                            <button class="guide-tooth-btn" onclick="openToothSelection('worry-teeth')">Ê≠ØÂºèÈÅ∏Êäû</button>
                            <div class="selected-teeth-display" id="worry-teeth">
                                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                            </div>
                            <div style="margin-top: 10px;">
                                <label>ÂêÑÊ≠Ø„ÅÆÊá∏Âøµ‰∫ãÈ†ÖÔºö</label>
                                <textarea class="guide-textarea" placeholder="ÈÅ∏Êäû„Åó„ÅüÊ≠Ø„Åù„Çå„Åû„Çå„ÅÆÊá∏Âøµ‰∫ãÈ†Ö"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- „Çª„ÇØ„Ç∑„Éß„É≥12ÔºöÊÇ£ËÄÖÊÑèÊ¨≤„Å®„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥ -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>12. ÊÇ£ËÄÖÊÑèÊ¨≤„Å®„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="guide-question">ÊÇ£ËÄÖ„ÅØ‰ªäÂõû„Åó„Å£„Åã„ÇäÊ≤ª„Åó„Åü„ÅÑ„Å®ÊÄù„Å£„Å¶„Åæ„Åô„ÅãÔºü</div>
                        <div class="guide-radio-group">
                            <div class="guide-radio-item">
                                <input type="radio" name="patient-motivation" id="very-motivated" value="„Åã„Å™„ÇäÊÄù„Å£„Å¶„Çã">
                                <label for="very-motivated">„Åã„Å™„ÇäÊÄù„Å£„Å¶„Çã</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="patient-motivation" id="somewhat-motivated" value="Â§öÂ∞ëÊÄù„Å£„Å¶„Çã">
                                <label for="somewhat-motivated">Â§öÂ∞ëÊÄù„Å£„Å¶„Çã</label>
                            </div>
                            <div class="guide-radio-item">
                                <input type="radio" name="patient-motivation" id="not-motivated" value="„ÅÇ„Åæ„ÇäÊÄù„Å£„Å¶„Å™„ÅÑ">
                                <label for="not-motivated">„ÅÇ„Åæ„ÇäÊÄù„Å£„Å¶„Å™„ÅÑ</label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Ë©±„ÅÆÂ∞éÂÖ•„Çí„Å©„ÅÜ„Åó„Åæ„Åô„ÅãÔºü</h4>
                            <p style="font-size: 12px; color: #666;">‰Ωï„ÇíÂÜíÈ†≠„Å´Ë©±„Çí„Åó„Åü„ÇâÊÇ£ËÄÖ„Åï„Çì„ÅåÊÑüÊÉÖ„ÇíÂãï„Åã„Åó„Å¶„ÄÅÁúüÂâ£„Å´„ÅîËá™Ë∫´„ÅÆÊ≠Ø„ÇÑÊ≤ªÁôÇ„Å´„Å§„ÅÑ„Å¶Âêë„ÅçÂêà„ÅÜ„Åß„Åó„Çá„ÅÜ„Åã„ÄÇÊÑüÊÉÖ„ÇíÂãï„Åã„Åó„Å¶„Åã„ÇâÁêÜË´ñ„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊäúÊ≠ØÈÉ®‰Ωç„Åå‰∏ªË®¥„Åß„ÅØ„Å™„ÅÑÊôÇ„ÅØ„ÄÅÊäúÊ≠Ø„ÅÆË©±„ÅØÊÖéÈáç„Å´„ÄÇ</p>
                            <textarea class="guide-textarea" style="min-height: 120px;" placeholder="„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥Êà¶Áï•„ÇíË®òÂÖ•"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Ëª¢Ë®ò„Éú„Çø„É≥ -->
                <button class="transfer-btn" onclick="transferToTreatmentPlan()">
                    Ê≤ªÁôÇË®àÁîªË°®„Å´Ëª¢Ë®ò„Åô„Çã
                </button>
            </div>
            
            <!-- Ê≤ªÁôÇË®àÁîªË°®„Çø„Éñ -->
            <div id="plan-tab" class="tab-content">
                <!-- „Éó„É©„É≥„Çø„Éñ -->
                <div class="plan-tabs">
                    <div class="plan-tab ideal active" onclick="switchPlanTab('ideal')">ÁêÜÊÉ≥„Éó„É©„É≥</div>
                    <div class="plan-tab standard" onclick="switchPlanTab('standard')">Ê®ôÊ∫ñ„Éó„É©„É≥</div>
                    <div class="plan-tab insurance" onclick="switchPlanTab('insurance')">‰øùÈô∫„Éó„É©„É≥</div>
                    <button class="add-plan-btn" onclick="addCustomPlan()">+ „Ç´„Çπ„Çø„É†„Éó„É©„É≥ËøΩÂä†</button>
                </div>
                
                <!-- ÂêÑ„Éó„É©„É≥„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                <div id="plan-ideal" class="plan-content active">
                    <!-- Ê≠ØÂºèÈÅ∏Êäû„Éë„É¨„ÉÉ„Éà -->
                    <div class="tooth-palette-container">
                        <div class="current-selection" id="currentSelection-ideal">
                            Ê≤ªÁôÇÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </div>
                        <div class="tooth-chart">
                            <div class="tooth-chart-grid">
                                <!-- ‰∏äÈ°é -->
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="8" onclick="selectTooth('Âè≥‰∏ä', 8, 'ideal')">8</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="7" onclick="selectTooth('Âè≥‰∏ä', 7, 'ideal')">7</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="6" onclick="selectTooth('Âè≥‰∏ä', 6, 'ideal')">6</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="5" onclick="selectTooth('Âè≥‰∏ä', 5, 'ideal')">5</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="4" onclick="selectTooth('Âè≥‰∏ä', 4, 'ideal')">4</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="3" onclick="selectTooth('Âè≥‰∏ä', 3, 'ideal')">3</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="2" onclick="selectTooth('Âè≥‰∏ä', 2, 'ideal')">2</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="1" onclick="selectTooth('Âè≥‰∏ä', 1, 'ideal')">1</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="1" onclick="selectTooth('Â∑¶‰∏ä', 1, 'ideal')">1</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="2" onclick="selectTooth('Â∑¶‰∏ä', 2, 'ideal')">2</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="3" onclick="selectTooth('Â∑¶‰∏ä', 3, 'ideal')">3</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="4" onclick="selectTooth('Â∑¶‰∏ä', 4, 'ideal')">4</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="5" onclick="selectTooth('Â∑¶‰∏ä', 5, 'ideal')">5</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="6" onclick="selectTooth('Â∑¶‰∏ä', 6, 'ideal')">6</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="7" onclick="selectTooth('Â∑¶‰∏ä', 7, 'ideal')">7</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="8" onclick="selectTooth('Â∑¶‰∏ä', 8, 'ideal')">8</button>
                                
                                <!-- ÂçÅÂ≠óÁ∑öÁî®„Çπ„Éö„Éº„Çπ -->
                                <div class="tooth-divider">
                                    <div class="cross-line-horizontal"></div>
                                    <div class="cross-line-vertical"></div>
                                </div>
                                
                                <!-- ‰∏ãÈ°é -->
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="8" onclick="selectTooth('Âè≥‰∏ã', 8, 'ideal')">8</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="7" onclick="selectTooth('Âè≥‰∏ã', 7, 'ideal')">7</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="6" onclick="selectTooth('Âè≥‰∏ã', 6, 'ideal')">6</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="5" onclick="selectTooth('Âè≥‰∏ã', 5, 'ideal')">5</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="4" onclick="selectTooth('Âè≥‰∏ã', 4, 'ideal')">4</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="3" onclick="selectTooth('Âè≥‰∏ã', 3, 'ideal')">3</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="2" onclick="selectTooth('Âè≥‰∏ã', 2, 'ideal')">2</button>
                                <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="1" onclick="selectTooth('Âè≥‰∏ã', 1, 'ideal')">1</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="1" onclick="selectTooth('Â∑¶‰∏ã', 1, 'ideal')">1</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="2" onclick="selectTooth('Â∑¶‰∏ã', 2, 'ideal')">2</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="3" onclick="selectTooth('Â∑¶‰∏ã', 3, 'ideal')">3</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="4" onclick="selectTooth('Â∑¶‰∏ã', 4, 'ideal')">4</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="5" onclick="selectTooth('Â∑¶‰∏ã', 5, 'ideal')">5</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="6" onclick="selectTooth('Â∑¶‰∏ã', 6, 'ideal')">6</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="7" onclick="selectTooth('Â∑¶‰∏ã', 7, 'ideal')">7</button>
                                <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="8" onclick="selectTooth('Â∑¶‰∏ã', 8, 'ideal')">8</button>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-danger" onclick="clearCurrentField('ideal')">ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢</button>
                        </div>
                    </div>

                    <!-- Ê≤ªÁôÇË®àÁîªË°® -->
                    <div class="section">
                        <div class="treatment-header">
                            <div class="header-inputs">
                                <div class="header-input">
                                    <label>Êó•‰ªòÔºö</label>
                                    <input type="date" id="planDate-ideal" value="">
                                </div>
                                <div class="header-input">
                                    <label>DrÔºö</label>
                                    <input type="text" id="planDoctorName-ideal" placeholder="ÂåªÂ∏´Âêç">
                                </div>
                                <div class="header-input">
                                    <label>DHÔºö</label>
                                    <input type="text" id="planDhName-ideal" placeholder="Ê≠ØÁßëË°õÁîüÂ£´Âêç">
                                </div>
                                <div class="medical-buttons">
                                    <button class="medical-btn" id="btn-soui-ideal" onclick="toggleMedicalBtn('soui', 'ideal')">Á∑èÂåª</button>
                                    <button class="medical-btn" id="btn-ikan-ideal" onclick="toggleMedicalBtn('ikan', 'ideal')">ÂåªÁÆ°</button>
                                </div>
                            </div>
                        </div>
                        
                        <table class="treatment-table">
                            <tbody>
                                <tr>
                                    <td width="10%">CR</td>
                                    <td width="15%" class="treatment-field" id="field-CR-ideal" onclick="selectField('CR', 'ideal')"></td>
                                    <td width="10%">SRP</td>
                                    <td width="15%" class="treatment-field" id="field-SRP-ideal" onclick="selectField('SRP', 'ideal')"></td>
                                    <td width="50%" rowspan="9" style="vertical-align: top;">
                                        <div class="remarks-section">
                                            <!-- ÊÇ£ËÄÖÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
                                            <div class="patient-info-section">
                                                <div>
                                                    <strong>‰∏ªË®¥Ôºö</strong>
                                                    <textarea id="chiefComplaint-ideal" class="patient-info-input" placeholder="Âè≥‰∏ä„ÅÆÊ≠Ø„ÅåÁóõ„ÅÑ" rows="2"></textarea>
                                                </div>
                                                <div>
                                                    <strong>ÂÖ®Ë∫´ÁñæÊÇ£Ôºö</strong>
                                                    <textarea id="medicalHistory-ideal" class="patient-info-input" placeholder="È´òË°ÄÂúß„ÄÅÁ≥ñÂ∞øÁóÖ„Å™„Å©" rows="2"></textarea>
                                                </div>
                                                <div>
                                                    <strong>ÊúçÁî®Ëñ¨Ôºö</strong>
                                                    <textarea id="medications-ideal" class="patient-info-input" placeholder="„Ç¢„É†„É≠„Ç∏„Éî„É≥ 5mg 1Êó•1Âõû" rows="2"></textarea>
                                                </div>
                                                <div>
                                                    <strong>Ê≥®ÊÑè‰∫ãÈ†ÖÔºö</strong>
                                                    <textarea id="precautions-ideal" class="patient-info-input" placeholder="„Ç¢„É¨„É´„ÇÆ„ÉºÔºö„Éö„Éã„Ç∑„É™„É≥" rows="2"></textarea>
                                                </div>
                                            </div>
                                            
                                            <!-- Âñ´ÁÖô -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">Âñ´ÁÖôÔºö</span>
                                                <div class="radio-group">
                                                    <label><input type="radio" name="smoking-ideal" value="ÁÑ°" checked> ÁÑ°</label>
                                                    <label><input type="radio" name="smoking-ideal" value="Êúâ"> Êúâ</label>
                                                    <input type="number" id="smokingAmount-ideal" class="remarks-input" placeholder="Êú¨Êï∞/Êó•" style="width: 80px; display: none;">
                                                </div>
                                            </div>
                                            
                                            <!-- Âí¨Âêà -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">Âí¨ÂêàÔºö</span>
                                                <input type="text" id="occlusion-ideal" class="remarks-input" placeholder="Âí¨ÂêàÁä∂ÊÖã„ÇíÂÖ•Âäõ">
                                            </div>
                                            
                                            <!-- Brx -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">BrxÔºö</span>
                                                <div class="select-group">
                                                    <button class="select-btn" data-field="brx" data-value="‰Ωé" onclick="selectOption('brx', '‰Ωé', 'ideal')">‰Ωé</button>
                                                    <button class="select-btn" data-field="brx" data-value="È´ò" onclick="selectOption('brx', 'È´ò', 'ideal')">È´ò</button>
                                                </div>
                                            </div>
                                            
                                            <!-- NG -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">NGÔºö</span>
                                                <div class="select-group">
                                                    <button class="select-btn" data-field="ng" data-value="Êúâ" onclick="selectOption('ng', 'Êúâ', 'ideal')">Êúâ</button>
                                                    <button class="select-btn" data-field="ng" data-value="ÁÑ°" onclick="selectOption('ng', 'ÁÑ°', 'ideal')">ÁÑ°</button>
                                                </div>
                                            </div>
                                            
                                            <!-- P -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">PÔºö</span>
                                                <div class="select-group">
                                                    <button class="select-btn" data-field="p" data-value="ËªΩÂ∫¶" onclick="selectOption('p', 'ËªΩÂ∫¶', 'ideal')">ËªΩÂ∫¶</button>
                                                    <button class="select-btn" data-field="p" data-value="‰∏≠Á≠âÂ∫¶" onclick="selectOption('p', '‰∏≠Á≠âÂ∫¶', 'ideal')">‰∏≠Á≠âÂ∫¶</button>
                                                    <button class="select-btn" data-field="p" data-value="ÈáçÂ∫¶" onclick="selectOption('p', 'ÈáçÂ∫¶', 'ideal')">ÈáçÂ∫¶</button>
                                                </div>
                                            </div>
                                            
                                            <!-- C -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">CÔºö</span>
                                                <div class="select-group">
                                                    <button class="select-btn" data-field="c" data-value="‰Ωé„ÅÑ" onclick="selectOption('c', '‰Ωé„ÅÑ', 'ideal')">‰Ωé„ÅÑ</button>
                                                    <button class="select-btn" data-field="c" data-value="È´ò„ÅÑ" onclick="selectOption('c', 'È´ò„ÅÑ', 'ideal')">È´ò„ÅÑ</button>
                                                </div>
                                            </div>
                                            
                                            <!-- ortho -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">orthoÔºö</span>
                                                <div class="select-group">
                                                    <button class="select-btn" data-field="ortho" data-value="‰∏çË¶Å" onclick="selectOption('ortho', '‰∏çË¶Å', 'ideal')">‰∏çË¶Å</button>
                                                    <button class="select-btn" data-field="ortho" data-value="Ë™¨ÊòéÊ∏à" onclick="selectOption('ortho', 'Ë™¨ÊòéÊ∏à', 'ideal')">Ë™¨ÊòéÊ∏à</button>
                                                    <button class="select-btn" data-field="ortho" data-value="Á¥π‰ªã" onclick="selectOption('ortho', 'Á¥π‰ªã', 'ideal')">Á¥π‰ªã</button>
                                                    <button class="select-btn" data-field="ortho" data-value="ÂΩìÈô¢" onclick="selectOption('ortho', 'ÂΩìÈô¢', 'ideal')">ÂΩìÈô¢</button>
                                                </div>
                                            </div>
                                            
                                            <!-- implant„Å®Hys -->
                                            <div class="special-treatments">
                                                <div class="special-treatment-item">
                                                    <div class="special-treatment-label">implant</div>
                                                    <div class="treatment-field" id="field-implant-ideal" onclick="selectField('implant', 'ideal')" style="min-height: 40px;"></div>
                                                </div>
                                                <div class="special-treatment-item">
                                                    <div class="special-treatment-label">Hys</div>
                                                    <div class="treatment-field" id="field-Hys-ideal" onclick="selectField('Hys', 'ideal')" style="min-height: 40px;"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Clear tools -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">Clear toolsÔºö</span>
                                                <textarea id="clearTools-ideal" class="remarks-input multi-line-input" rows="2" placeholder="Ê∏ÖÊéÉÂô®ÂÖ∑„ÇíÂÖ•Âäõ"></textarea>
                                            </div>
                                            
                                            <!-- OHIÊñπÈáù -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">OHIÊñπÈáùÔºö</span>
                                                <textarea id="ohiPolicy-ideal" class="remarks-input multi-line-input" rows="2" placeholder="Âè£ËÖîË°õÁîüÊåáÂ∞éÊñπÈáù„ÇíÂÖ•Âäõ"></textarea>
                                            </div>
                                            
                                            <!-- ÂÇôËÄÉ -->
                                            <div class="remarks-row">
                                                <span class="remarks-label">ÂÇôËÄÉÔºö</span>
                                                <textarea id="remarksNotes-ideal" class="remarks-input" rows="2" placeholder="„Åù„ÅÆ‰ªñÂÇôËÄÉ"></textarea>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>MTA</td>
                                    <td class="treatment-field" id="field-MTA-ideal" onclick="selectField('MTA', 'ideal')"></td>
                                    <td>EXT</td>
                                    <td class="treatment-field" id="field-EXT-ideal" onclick="selectField('EXT', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td class="treatment-cell long-text">„Ç®„ÇØ„Çπ„Éà„É´„Éº„Ç∏„Éß„É≥</td>
                                    <td class="treatment-field" id="field-„Ç®„ÇØ„Çπ„Éà„É´„Éº„Ç∏„Éß„É≥-ideal" onclick="selectField('„Ç®„ÇØ„Çπ„Éà„É´„Éº„Ç∏„Éß„É≥', 'ideal')"></td>
                                    <td class="treatment-cell long-text">„ÇØ„É©„Ç¶„É≥„É¨„É≥„Ç∞„Çπ</td>
                                    <td class="treatment-field" id="field-„ÇØ„É©„Ç¶„É≥„É¨„É≥„Ç∞„Çπ-ideal" onclick="selectField('„ÇØ„É©„Ç¶„É≥„É¨„É≥„Ç∞„Çπ', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>IN</td>
                                    <td class="treatment-field" id="field-IN-ideal" onclick="selectField('IN', 'ideal')"></td>
                                    <td>„ÇΩ„Ç±„Éó„É™</td>
                                    <td class="treatment-field" id="field-„ÇΩ„Ç±„Éó„É™-ideal" onclick="selectField('„ÇΩ„Ç±„Éó„É™', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>ENDO</td>
                                    <td class="treatment-field" id="field-ENDO-ideal" onclick="selectField('ENDO', 'ideal')"></td>
                                    <td>„Ç§„É≥„Éó„É©„É≥„Éà</td>
                                    <td class="treatment-field" id="field-„Ç§„É≥„Éó„É©„É≥„Éà-ideal" onclick="selectField('„Ç§„É≥„Éó„É©„É≥„Éà', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>Cr</td>
                                    <td class="treatment-field" id="field-Cr-ideal" onclick="selectField('Cr', 'ideal')"></td>
                                    <td>ÂÜçÁîüÁôÇÊ≥ï</td>
                                    <td class="treatment-field" id="field-ÂÜçÁîüÁôÇÊ≥ï-ideal" onclick="selectField('ÂÜçÁîüÁôÇÊ≥ï', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>Br</td>
                                    <td class="treatment-field" id="field-Br-ideal" onclick="selectField('Br', 'ideal')"></td>
                                    <td><input type="text" id="customRow7-ideal" class="custom-field-input" placeholder="È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ"></td>
                                    <td class="treatment-field" id="field-customRow7-ideal" onclick="selectField('customRow7', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>OBS</td>
                                    <td class="treatment-field" id="field-OBS-ideal" onclick="selectField('OBS', 'ideal')"></td>
                                    <td><input type="text" id="customRow8-ideal" class="custom-field-input" placeholder="È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ"></td>
                                    <td class="treatment-field" id="field-customRow8-ideal" onclick="selectField('customRow8', 'ideal')"></td>
                                </tr>
                                <tr>
                                    <td>Ëá™Áî±Ë®òÂÖ•Ê¨Ñ</td>
                                    <td><textarea id="freeText-ideal" class="free-text-area" placeholder="Ëá™Áî±Ë®òÂÖ•Ê¨Ñ"></textarea></td>
                                    <td>NG</td>
                                    <td><textarea id="ngText-ideal" class="ng-text-input" placeholder="NG„ÅÆË©≥Á¥∞„ÇíÂÖ•Âäõ" rows="2"></textarea></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Ê≤ªÁôÇÈ†ÜÂ∫è -->
                    <div class="section">
                        <h3>Ê≤ªÁôÇÈ†ÜÂ∫è</h3>
                        <div class="treatment-order-container">
                            <div class="auto-generate-section">
                                <p style="margin: 0 0 10px 0;">Ê≤ªÁôÇË®àÁîª„Åã„ÇâËá™ÂãïÁöÑ„Å´Ê≤ªÁôÇÈ†ÜÂ∫è„ÇíÁîüÊàê„Åó„Åæ„Åô</p>
                                <button class="auto-generate-btn" onclick="autoGenerateTreatmentOrder('ideal')">
                                    <span>üîÑ</span>
                                    <span>Ê≤ªÁôÇÈ†ÜÂ∫è„ÇíËá™ÂãïÁîüÊàê</span>
                                </button>
                            </div>
                            <div id="treatmentOrderList-ideal">
                                <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                            </div>
                            <button class="add-order-btn" onclick="addTreatmentOrder('ideal')">+ Ê≤ªÁôÇÈ†ÜÂ∫è„ÇíËøΩÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ê®ôÊ∫ñ„Éó„É©„É≥„Éª‰øùÈô∫„Éó„É©„É≥„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÊßãÈÄ†„ÅØÁêÜÊÉ≥„Éó„É©„É≥„Å®Âêå„ÅòÔºâ -->
                <div id="plan-standard" class="plan-content" style="display: none;">
                    <!-- ÁêÜÊÉ≥„Éó„É©„É≥„Å®Âêå„ÅòÊßãÈÄ†„Çíplan-standard„ÅÆID„ÅßÂÆüË£Ö -->
                </div>
                
                <div id="plan-insurance" class="plan-content" style="display: none;">
                    <!-- ÁêÜÊÉ≥„Éó„É©„É≥„Å®Âêå„ÅòÊßãÈÄ†„Çíplan-insurance„ÅÆID„ÅßÂÆüË£Ö -->
                </div>
            </div>
        </div>
    </div>

    <!-- Ê≠ØÂºèÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="toothSelectionModal" class="tooth-selection-modal">
        <div class="tooth-selection-content">
            <div class="tooth-selection-header">
                <h3 class="tooth-selection-title" id="toothSelectionTitle">Ê≠ØÂºèÈÅ∏Êäû</h3>
                <span class="close" onclick="closeToothSelection()">&times;</span>
            </div>
                  <div class="tooth-chart">
                <div class="tooth-chart-grid">
                    <!-- ‰∏äÈ°é -->
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="8" onclick="selectToothInModal('Âè≥‰∏ä', 8)">8</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="7" onclick="selectToothInModal('Âè≥‰∏ä', 7)">7</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="6" onclick="selectToothInModal('Âè≥‰∏ä', 6)">6</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="5" onclick="selectToothInModal('Âè≥‰∏ä', 5)">5</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="4" onclick="selectToothInModal('Âè≥‰∏ä', 4)">4</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="3" onclick="selectToothInModal('Âè≥‰∏ä', 3)">3</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="2" onclick="selectToothInModal('Âè≥‰∏ä', 2)">2</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ä" data-number="1" onclick="selectToothInModal('Âè≥‰∏ä', 1)">1</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="1" onclick="selectToothInModal('Â∑¶‰∏ä', 1)">1</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="2" onclick="selectToothInModal('Â∑¶‰∏ä', 2)">2</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="3" onclick="selectToothInModal('Â∑¶‰∏ä', 3)">3</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="4" onclick="selectToothInModal('Â∑¶‰∏ä', 4)">4</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="5" onclick="selectToothInModal('Â∑¶‰∏ä', 5)">5</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="6" onclick="selectToothInModal('Â∑¶‰∏ä', 6)">6</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="7" onclick="selectToothInModal('Â∑¶‰∏ä', 7)">7</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ä" data-number="8" onclick="selectToothInModal('Â∑¶‰∏ä', 8)">8</button>
                    
                    <!-- ÂçÅÂ≠óÁ∑öÁî®„Çπ„Éö„Éº„Çπ -->
                    <div class="tooth-divider">
                        <div class="cross-line-horizontal"></div>
                        <div class="cross-line-vertical"></div>
                    </div>
                    
                    <!-- ‰∏ãÈ°é -->
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="8" onclick="selectToothInModal('Âè≥‰∏ã', 8)">8</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="7" onclick="selectToothInModal('Âè≥‰∏ã', 7)">7</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="6" onclick="selectToothInModal('Âè≥‰∏ã', 6)">6</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="5" onclick="selectToothInModal('Âè≥‰∏ã', 5)">5</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="4" onclick="selectToothInModal('Âè≥‰∏ã', 4)">4</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="3" onclick="selectToothInModal('Âè≥‰∏ã', 3)">3</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="2" onclick="selectToothInModal('Âè≥‰∏ã', 2)">2</button>
                    <button class="tooth-btn" data-position="Âè≥‰∏ã" data-number="1" onclick="selectToothInModal('Âè≥‰∏ã', 1)">1</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="1" onclick="selectToothInModal('Â∑¶‰∏ã', 1)">1</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="2" onclick="selectToothInModal('Â∑¶‰∏ã', 2)">2</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="3" onclick="selectToothInModal('Â∑¶‰∏ã', 3)">3</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="4" onclick="selectToothInModal('Â∑¶‰∏ã', 4)">4</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="5" onclick="selectToothInModal('Â∑¶‰∏ã', 5)">5</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="6" onclick="selectToothInModal('Â∑¶‰∏ã', 6)">6</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="7" onclick="selectToothInModal('Â∑¶‰∏ã', 7)">7</button>
                    <button class="tooth-btn" data-position="Â∑¶‰∏ã" data-number="8" onclick="selectToothInModal('Â∑¶‰∏ã', 8)">8</button>
                </div>
            </div>
            <div class="selected-teeth-display" id="modalSelectedTeeth" style="margin-top: 20px;">
                ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
            </div>
            <div class="tooth-selection-buttons">
                <button class="btn btn-danger" onclick="clearModalSelection()">ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢</button>
                <button class="btn btn-primary" onclick="confirmToothSelection()">Á¢∫ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº -->
    <div class="action-bar">
        <button class="btn btn-primary" onclick="saveData()">‰∏ÄÊôÇ‰øùÂ≠ò</button>
        <button class="btn btn-secondary" onclick="showLoadModal()">‰øùÂ≠ò„Éá„Éº„ÇøË™≠Ëæº</button>
        <button class="btn btn-success" onclick="generatePDF()">PDF‰ΩúÊàêÔºàÂÖ®‰ΩìÔºâ</button>
        <button class="btn btn-info" onclick="generateTreatmentOnlyPDF()">PDF‰ΩúÊàêÔºàÊ≤ªÁôÇË®àÁîª„ÅÆ„ÅøÔºâ</button>
        <button class="btn btn-warning" onclick="generateComparisonPDF()">„Éó„É©„É≥ÊØîËºÉPDF</button>
        <button class="btn btn-danger" onclick="clearAll()">„Åô„Åπ„Å¶„ÇØ„É™„Ç¢</button>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Âá¶ÁêÜ‰∏≠...</p>
    </div>

    <!-- Ë™≠„ÅøËæº„Åø„É¢„Éº„ÉÄ„É´ -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoadModal()">&times;</span>
            <h2>‰øùÂ≠òÊ∏à„Åø„Éá„Éº„Çø</h2>
            <div id="fileList">
                <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>
        </div>
    </div>
     
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let activeField = null;
        let activePlan = 'ideal';
        let selectedTeeth = {
            ideal: {},
            standard: {},
            insurance: {}
        };
        let uploadedImages = {};
        let imageTransforms = {};
        let treatmentOrderCounter = {
            ideal: 0,
            standard: 0,
            insurance: 0
        };
        let medicalManagement = {
            ideal: [],
            standard: [],
            insurance: []
        };
        let remarksData = {
            ideal: {},
            standard: {},
            insurance: {}
        };
        let currentViewMode = 'single';
        let customFields = {
            ideal: {},
            standard: {},
            insurance: {}
        };
        let draggedThumbnail = null;
        let customPlanCounter = 0;
        
        // Ê≤ªÁôÇË®àÁîªÁ´ãÊ°à„Ç¨„Ç§„Éâ„ÅÆ„Éá„Éº„Çø
        let planningGuideData = {
            patientBackground: {},
            extractionTeeth: [],
            prognosisTeeth: [],
            occlusionIssues: {},
            occlusionClass: '',
            insurancePlan: {},
            orthodontics: {},
            implantPlan: {},
            futureRisk: {},
            selfPayOptions: {},
            longTermPrognosis: {},
            patientCommunication: {}
        };
        
        // Ê≠ØÂºèÈÅ∏Êäû„É¢„Éº„ÉÄ„É´Áî®
        let currentToothSelectionType = '';
        let modalSelectedTeeth = [];

        // Ê≤ªÁôÇÈ†ÖÁõÆ„ÅÆ„É™„Çπ„Éà
        const treatmentOptions = [
            'CR', 'MTA', 'IN', 'ENDO', '„Ç®„ÇØ„Çπ„Éà„É´„Éº„Ç∏„Éß„É≥', '„ÇØ„É©„Ç¶„É≥„É¨„É≥„Ç∞„Çπ', 
            'Cr', 'Br', 'OBS', 'SRP', 'EXT', '„ÇΩ„Ç±„Éó„É™', '„Ç§„É≥„Éó„É©„É≥„Éà', 
            'ÂÜçÁîüÁôÇÊ≥ï', 'NG', 'implant', 'Hys', '„É°„É≥„ÉÜ„Éä„É≥„Çπ', 'TBI', 'SC', 'PMTC'
        ];

        // Ê≤ªÁôÇÂÑ™ÂÖàÂ∫¶„Éû„ÉÉ„Éî„É≥„Ç∞
        const treatmentPriority = {
            'EXT': 1,
            'ENDO': 2,
            'MTA': 3,
            'SRP': 4,
            'CR': 5,
            'IN': 5,
            'Cr': 6,
            'Br': 7,
            '„Ç§„É≥„Éó„É©„É≥„Éà': 8,
            'ÂÜçÁîüÁôÇÊ≥ï': 4,
            '„Ç®„ÇØ„Çπ„Éà„É´„Éº„Ç∏„Éß„É≥': 3,
            '„ÇØ„É©„Ç¶„É≥„É¨„É≥„Ç∞„Çπ': 3,
            '„ÇΩ„Ç±„Éó„É™': 2,
            'OBS': 9,
            'NG': 9,
            'implant': 8,
            'Hys': 10
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeSplitPane();
            initializeDragAndDrop();
            initializeSmokingToggle();
            initializeTextareaAutoResize();
            initializeCustomFields();
            initializeAdvancedToothSelection();
            initializeImageDragAndDrop();
            initializeGalleryDragAndDrop();
            initializeAccordions();
            initializeGuideEventListeners();
            
            // ÂêÑ„Éó„É©„É≥„Å´Ê≤ªÁôÇÈ†ÜÂ∫è„ÇíËøΩÂä†
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                addTreatmentOrder(plan);
            });
            
            // Êó•‰ªò„ÅÆÂàùÊúüÂÄ§„Çí‰ªäÊó•„Å´Ë®≠ÂÆö
            const today = new Date().toISOString().split('T')[0];
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                const dateInput = document.getElementById(`planDate-${plan}`);
                if (dateInput) {
                    dateInput.value = today;
                }
            });
        });

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆÂàùÊúüÂåñ
        function initializeAccordions() {
            const headers = document.querySelectorAll('.accordion-header');
            headers.forEach(header => {
                header.addEventListener('click', () => toggleAccordion(header));
            });
        }

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆ„Éà„Ç∞„É´
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.accordion-icon');
            
            header.classList.toggle('active');
            content.classList.toggle('active');
            
            updateProgress();
        }

        // ÈÄ≤Êçó„ÅÆÊõ¥Êñ∞
        function updateProgress() {
            const totalSections = 12;
            let completedSections = 0;
            
            // ÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂÆå‰∫ÜÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const accordions = document.querySelectorAll('.accordion');
            accordions.forEach(accordion => {
                const content = accordion.querySelector('.accordion-content');
                const hasInput = content.querySelector('input:checked, textarea:not(:placeholder-shown), .selected-teeth-display:not(:empty)');
                if (hasInput) {
                    completedSections++;
                }
            });
            
            const progress = Math.round((completedSections / totalSections) * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${progress}% ÂÆå‰∫Ü`;
        }

        // „Ç¨„Ç§„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñ
        function initializeGuideEventListeners() {
            // Âí¨ÂêàÂàÜÈ°û„ÅÆ„Åù„ÅÆ‰ªñÈÅ∏ÊäûÊôÇ
            document.getElementById('class-other').addEventListener('change', function() {
                const otherDetail = document.getElementById('occlusion-other-detail');
                otherDetail.style.display = this.checked ? 'block' : 'none';
            });
            
            // Ë£úÁ∂¥„Çø„Ç§„Éó„ÅÆÈÅ∏ÊäûÊôÇ
            document.querySelectorAll('input[name="prosthesis-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('bridge-options').style.display = 
                        this.value === 'bridge' ? 'block' : 'none';
                    document.getElementById('denture-options').style.display = 
                        this.value === 'denture' ? 'block' : 'none';
                });
            });
        }

        // „É°„Ç§„É≥„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
        function switchMainTab(tab) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // „Éó„É©„É≥„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
        function switchPlanTab(plan) {
            activePlan = plan;
            
            // „Çø„Éñ„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.plan-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.plan-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`plan-${plan}`).style.display = 'block';
        }

        // „Ç´„Çπ„Çø„É†„Éó„É©„É≥„ÅÆËøΩÂä†
        function addCustomPlan() {
            customPlanCounter++;
            const planId = `custom${customPlanCounter}`;
            
            // „Çø„Éñ„ÅÆËøΩÂä†
            const tabContainer = document.querySelector('.plan-tabs');
            const newTab = document.createElement('div');
            newTab.className = 'plan-tab custom';
            newTab.textContent = `„Ç´„Çπ„Çø„É†${customPlanCounter}`;
            newTab.onclick = () => switchPlanTab(planId);
            tabContainer.insertBefore(newTab, tabContainer.lastElementChild);
            
            // „Éá„Éº„ÇøÊßãÈÄ†„ÅÆÂàùÊúüÂåñ
            selectedTeeth[planId] = {};
            treatmentOrderCounter[planId] = 0;
            medicalManagement[planId] = [];
            remarksData[planId] = {};
            customFields[planId] = {};
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ‰ΩúÊàêÔºàÁêÜÊÉ≥„Éó„É©„É≥„Çí„Ç≥„Éî„ÉºÔºâ
            const idealContent = document.getElementById('plan-ideal');
            const newContent = idealContent.cloneNode(true);
            newContent.id = `plan-${planId}`;
            newContent.style.display = 'none';
            
            // IDÂ±ûÊÄß„ÅÆÊõ¥Êñ∞
            updateElementIds(newContent, 'ideal', planId);
            
            // Ë¶™Ë¶ÅÁ¥†„Å´ËøΩÂä†
            document.getElementById('plan-tab').appendChild(newContent);
            
            // Êñ∞„Åó„ÅÑ„Éó„É©„É≥„Å´Âàá„ÇäÊõø„Åà
            switchPlanTab(planId);
        }

        // Ë¶ÅÁ¥†„ÅÆID„ÇíÊõ¥Êñ∞
        function updateElementIds(element, oldPlan, newPlan) {
            // Ëá™Ë∫´„ÅÆID„ÇíÊõ¥Êñ∞
            if (element.id && element.id.includes(oldPlan)) {
                element.id = element.id.replace(oldPlan, newPlan);
            }
            
            // onclickÂ±ûÊÄß„ÇíÊõ¥Êñ∞
            if (element.onclick) {
                const onclickStr = element.onclick.toString();
                element.onclick = new Function(onclickStr.replace(new RegExp(oldPlan, 'g'), newPlan));
            }
            
            // Â≠êË¶ÅÁ¥†„ÇíÂÜçÂ∏∞ÁöÑ„Å´Êõ¥Êñ∞
            Array.from(element.children).forEach(child => {
                updateElementIds(child, oldPlan, newPlan);
            });
        }

        // Ê≠ØÂºèÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openToothSelection(type) {
            currentToothSelectionType = type;
            modalSelectedTeeth = [];
            
            // „Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
            const titles = {
                'extraction': 'ÊäúÊ≠Ø„ÅåÂøÖË¶Å„Å™Ê≠Ø',
                'prognosis': '‰∫àÂæå‰∏çËâØÊ≠ØÔºà3Âπ¥‰ª•ÂÜÖÔºâ',
                'extrusion': 'Êå∫Âá∫„Åó„Å¶„ÅÑ„ÇãÊ≠Ø',
                'wear': 'Ê•µÁ´Ø„Å´Âí¨ËÄó„Åó„Å¶„ÅÑ„ÇãÊ≠Ø',
                'caries': '„Ç´„É™„Ç®„Çπ„Åå„ÅÇ„ÇãÊ≠Ø',
                'pulpectomy': 'ÊäúÈ´Ñ„ÅåÂøÖË¶Å„Å™Ê≠Ø',
                'poor-prosthesis': '‰∏çËâØË£úÁ∂¥Áâ©',
                'endo': 'Ê†πÁÆ°Ê≤ªÁôÇ„ÅåÂøÖË¶Å„Å™ÈÉ®‰Ωç',
                'missing': 'Ê¨†ÊêçÈÉ®‰Ωç',
                'additional-abutment': 'ËøΩÂä†ÊîØÂè∞Ê≠Ø',
                'clasp': 'Èâ§Ê≠Ø',
                'implant-plan': '„Ç§„É≥„Éó„É©„É≥„ÉàÂüãÂÖ•‰∫àÂÆöÈÉ®‰Ωç',
                'implant-all': 'ÂÖ®„Å¶ÂÖ•„Çå„ÅüÂ†¥Âêà',
                'implant-min': 'ÊúÄÂ∞èÈôê„ÅÆÂ†¥Âêà',
                'implant-recommend': 'Êé®Â•®„Éó„É©„É≥',
                'future-implant': 'Â∞ÜÊù•„Ç§„É≥„Éó„É©„É≥„Éà„ÅåÂøÖË¶Å„Å´„Å™„Çä„Åù„ÅÜ„Å™ÈÉ®‰Ωç',
                'magnet-teeth': '„Éû„Ç∞„Éç„ÉÉ„ÉàË®≠ÁΩÆÊ≠Ø',
                'worry-teeth': '5-10Âπ¥„ÅßÂøÉÈÖç„Å™Ê≠Ø'
            };
            
            document.getElementById('toothSelectionTitle').textContent = titles[type] || 'Ê≠ØÂºèÈÅ∏Êäû';
            
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„ÇíÂæ©ÂÖÉ
            if (planningGuideData[type]) {
                modalSelectedTeeth = [...planningGuideData[type]];
            }
            
            updateModalToothDisplay();
            document.getElementById('toothSelectionModal').style.display = 'block';
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„ÅÆÊ≠Ø„ÅÆÈÅ∏Êäû
        function selectToothInModal(position, number) {
            const index = modalSelectedTeeth.findIndex(t => 
                t.position === position && t.number === number
            );
            
            if (index > -1) {
                modalSelectedTeeth.splice(index, 1);
            } else {
                modalSelectedTeeth.push({ position, number });
            }
            
            updateModalToothDisplay();
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆË°®Á§∫Êõ¥Êñ∞
        function updateModalToothDisplay() {
            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('#toothSelectionModal .tooth-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            modalSelectedTeeth.forEach(tooth => {
                const btn = document.querySelector(`#toothSelectionModal .tooth-btn[data-position="${tooth.position}"][data-number="${tooth.number}"]`);
                if (btn) btn.classList.add('selected');
            });
            
            // ÈÅ∏ÊäûË°®Á§∫„ÅÆÊõ¥Êñ∞
            const display = document.getElementById('modalSelectedTeeth');
            if (modalSelectedTeeth.length === 0) {
                display.textContent = 'ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô';
            } else {
                display.innerHTML = modalSelectedTeeth.map(tooth => 
                    `<span class="tooth-item">${tooth.position}${tooth.number}</span>`
                ).join('');
            }
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
        function clearModalSelection() {
            modalSelectedTeeth = [];
            updateModalToothDisplay();
        }

        // Ê≠ØÂºèÈÅ∏Êäû„ÇíÁ¢∫ÂÆö
        function confirmToothSelection() {
            planningGuideData[currentToothSelectionType] = [...modalSelectedTeeth];
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            const displayId = `${currentToothSelectionType}-teeth`;
            const displayElement = document.getElementById(displayId);
            if (displayElement) {
                if (modalSelectedTeeth.length === 0) {
                    displayElement.textContent = 'ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠Ø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô';
                } else {
                    displayElement.innerHTML = modalSelectedTeeth.map(tooth => 
                        `<span class="tooth-item">${tooth.position}${tooth.number}</span>`
                    ).join('');
                }
            }
            
            closeToothSelection();
            updateProgress();
        }

        // Ê≠ØÂºèÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeToothSelection() {
            document.getElementById('toothSelectionModal').style.display = 'none';
        }

        // Ê≤ªÁôÇË®àÁîª„Å∏„ÅÆËª¢Ë®ò
        function transferToTreatmentPlan() {
            if (!confirm('Á´ãÊ°à„Ç¨„Ç§„Éâ„ÅÆÂÜÖÂÆπ„ÇíÊ≤ªÁôÇË®àÁîªË°®„Å´Ëª¢Ë®ò„Åó„Åæ„Åô„ÅãÔºü\nÂØæË±°„Éó„É©„É≥: ' + getPlanDisplayName(activePlan))) {
                return;
            }
            
            // ÊäúÊ≠ØÈÅ©ÂøúÊ≠Ø ‚Üí EXT
            if (planningGuideData.extraction && planningGuideData.extraction.length > 0) {
                selectedTeeth[activePlan]['EXT'] = [...planningGuideData.extraction];
                updateFieldDisplay('EXT', activePlan);
            }
            
            // „Ç´„É™„Ç®„Çπ ‚Üí CR
            if (planningGuideData.caries && planningGuideData.caries.length > 0) {
                selectedTeeth[activePlan]['CR'] = [...planningGuideData.caries];
                updateFieldDisplay('CR', activePlan);
            }
            
            // Ê†πÁÆ°Ê≤ªÁôÇ ‚Üí ENDO
            if (planningGuideData.endo && planningGuideData.endo.length > 0) {
                selectedTeeth[activePlan]['ENDO'] = [...planningGuideData.endo];
                updateFieldDisplay('ENDO', activePlan);
            }
            
            // „Ç§„É≥„Éó„É©„É≥„ÉàË®àÁîª ‚Üí „Ç§„É≥„Éó„É©„É≥„Éà
            if (planningGuideData['implant-recommend'] && planningGuideData['implant-recommend'].length > 0) {
                selectedTeeth[activePlan]['„Ç§„É≥„Éó„É©„É≥„Éà'] = [...planningGuideData['implant-recommend']];
                updateFieldDisplay('„Ç§„É≥„Éó„É©„É≥„Éà', activePlan);
            }
            
            // ÊÇ£ËÄÖÊÉÖÂ†±„ÅÆËª¢Ë®ò
            const patientName = document.getElementById('patientName').value;
            const patientId = document.getElementById('patientId').value;
            
            // ‰∏ªË®¥Á≠â„ÅÆËª¢Ë®òÔºàÊúÄÂàù„ÅÆ„Éó„É©„É≥„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (activePlan === 'ideal') {
                // ÊÇ£ËÄÖËÉåÊôØÊÉÖÂ†±„ÇíÂÇôËÄÉÊ¨Ñ„Å´Ëª¢Ë®ò
                let notes = '';
                const backgrounds = document.querySelectorAll('.guide-checkbox-item input:checked');
                backgrounds.forEach(checkbox => {
                    const label = checkbox.nextElementSibling.textContent;
                    const detail = checkbox.parentElement.querySelector('.guide-detail-input');
                    if (detail && detail.value) {
                        notes += `${label}: ${detail.value}\n`;
                    }
                });
                
                if (notes) {
                    document.getElementById(`remarksNotes-${activePlan}`).value = notes;
                }
            }
            
            alert('Ê≤ªÁôÇË®àÁîªË°®„Å∏„ÅÆËª¢Ë®ò„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
            switchMainTab('plan');
        }

        // „Éó„É©„É≥Ë°®Á§∫Âêç„ÅÆÂèñÂæó
        function getPlanDisplayName(planKey) {
            const names = {
                'ideal': 'ÁêÜÊÉ≥„Éó„É©„É≥',
                'standard': 'Ê®ôÊ∫ñ„Éó„É©„É≥',
                'insurance': '‰øùÈô∫„Éó„É©„É≥'
            };
            return names[planKey] || `„Ç´„Çπ„Çø„É†„Éó„É©„É≥${planKey.replace('custom', '')}`;
        }

        // ÁîªÂÉè„ÅÆ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÔºà„Çµ„É†„Éç„Ç§„É´ÈñìÔºâ
        function initializeImageDragAndDrop() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('dragstart', handleImageDragStart);
                thumbnail.addEventListener('dragend', handleImageDragEnd);
                thumbnail.addEventListener('dragover', handleImageDragOver);
                thumbnail.addEventListener('drop', handleImageDrop);
                thumbnail.addEventListener('dragleave', handleImageDragLeave);
            });
        }

        // ÁîªÂÉè„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        function handleImageDragStart(e) {
            if (!this.classList.contains('has-image')) {
                e.preventDefault();
                return;
            }
            
            draggedThumbnail = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            
            const img = this.querySelector('img');
            if (img) {
                e.dataTransfer.setData('text/plain', img.src);
            }
        }

        // ÁîªÂÉè„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
        function handleImageDragEnd(e) {
            this.classList.remove('dragging');
            draggedThumbnail = null;
            
            document.querySelectorAll('.thumbnail.drag-over').forEach(thumb => {
                thumb.classList.remove('drag-over');
            });
        }

        // ÁîªÂÉè„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
        function handleImageDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            
            if (draggedThumbnail && draggedThumbnail !== this) {
                this.classList.add('drag-over');
            }
            
            return false;
        }

        // ÁîªÂÉè„Éâ„É©„ÉÉ„Ç∞„É™„Éº„Éñ
        function handleImageDragLeave(e) {
            this.classList.remove('drag-over');
        }

        // ÁîªÂÉè„Éâ„É≠„ÉÉ„ÉóÔºà„Çµ„É†„Éç„Ç§„É´Èñì„ÅÆÂÖ•„ÇåÊõø„ÅàÔºâ
        function handleImageDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            this.classList.remove('drag-over');
            
            if (draggedThumbnail && draggedThumbnail !== this) {
                swapImages(draggedThumbnail, this);
            }
            
            return false;
        }

        // ÁîªÂÉè„ÇíÂÖ•„ÇåÊõø„Åà„Çã
        function swapImages(source, target) {
            const sourceImg = source.querySelector('img');
            const targetImg = target.querySelector('img');
            
            const sourceType = source.dataset.type;
            const sourcePosition = source.dataset.position;
            const targetType = target.dataset.type;
            const targetPosition = target.dataset.position;
            
            const tempImageData = uploadedImages[sourceType]?.[sourcePosition];
            const tempTransform = imageTransforms[`${sourceType}-${sourcePosition}`];
            
            if (targetImg) {
                uploadedImages[sourceType][sourcePosition] = uploadedImages[targetType][targetPosition];
                imageTransforms[`${sourceType}-${sourcePosition}`] = imageTransforms[`${targetType}-${targetPosition}`];
            } else {
                if (uploadedImages[sourceType]) {
                    delete uploadedImages[sourceType][sourcePosition];
                }
                delete imageTransforms[`${sourceType}-${sourcePosition}`];
            }
            
            if (tempImageData) {
                if (!uploadedImages[targetType]) {
                    uploadedImages[targetType] = {};
                }
                uploadedImages[targetType][targetPosition] = tempImageData;
                if (tempTransform) {
                    imageTransforms[`${targetType}-${targetPosition}`] = tempTransform;
                }
            } else {
                if (uploadedImages[targetType]) {
                    delete uploadedImages[targetType][targetPosition];
                }
                delete imageTransforms[`${targetType}-${targetPosition}`];
            }
            
            if (sourceImg && targetImg) {
                const tempSrc = sourceImg.src;
                sourceImg.src = targetImg.src;
                targetImg.src = tempSrc;
                
                applyImageTransform(sourceImg, `${sourceType}-${sourcePosition}`);
                applyImageTransform(targetImg, `${targetType}-${targetPosition}`);
            } else if (sourceImg && !targetImg) {
                source.removeChild(sourceImg);
                source.classList.remove('has-image');
                
                const newImg = document.createElement('img');
                newImg.src = sourceImg.src;
                target.appendChild(newImg);
                target.classList.add('has-image');
                
                if (imageTransforms[`${targetType}-${targetPosition}`]) {
                    applyImageTransform(newImg, `${targetType}-${targetPosition}`);
                }
            }
            
            if (currentViewMode === 'split') {
                updateSplitView();
            }
        }

        // „ÇÆ„É£„É©„É™„Éº„Çª„ÇØ„Ç∑„Éß„É≥„Å∏„ÅÆË§áÊï∞ÁîªÂÉè„Éâ„É≠„ÉÉ„Éó
        function initializeGalleryDragAndDrop() {
            const gallerySections = document.querySelectorAll('.gallery-section[data-section-type]');
            
            gallerySections.forEach(section => {
                section.addEventListener('dragover', handleGalleryDragOver);
                section.addEventListener('drop', handleGalleryDrop);
                section.addEventListener('dragleave', handleGalleryDragLeave);
            });
        }

        // „ÇÆ„É£„É©„É™„Éº„Å∏„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
        function handleGalleryDragOver(e) {
            e.preventDefault();
            
            if (!draggedThumbnail) {
                this.classList.add('drag-over');
            }
        }

        // „ÇÆ„É£„É©„É™„Éº„Åã„Çâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞„É™„Éº„Éñ
        function handleGalleryDragLeave(e) {
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        // „ÇÆ„É£„É©„É™„Éº„Å∏„ÅÆ„Éâ„É≠„ÉÉ„ÉóÔºàË§áÊï∞ÁîªÂÉèÂØæÂøúÔºâ
        function handleGalleryDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedThumbnail) {
                return;
            }
            
            const files = e.dataTransfer.files;
            if (files.length === 0) return;
            
            const sectionType = this.dataset.sectionType;
            const maxImages = parseInt(this.dataset.maxImages) || 999;
            
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (imageFiles.length > maxImages) {
                alert(`ÊúÄÂ§ß${maxImages}Êûö„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô`);
                return;
            }
            
            let thumbnails = [];
            if (sectionType === 'intraoral') {
                thumbnails = Array.from(this.querySelectorAll('.thumbnail[data-type="intraoral"]'));
            } else if (sectionType === 'dental10') {
                thumbnails = Array.from(this.querySelectorAll('.thumbnail[data-type="xray"][data-position^="10-"]'));
            }
            
            const emptyThumbnails = thumbnails.filter(thumb => !thumb.classList.contains('has-image'));
            
            imageFiles.forEach((file, index) => {
                if (index < emptyThumbnails.length) {
                    handleImageUpload(file, emptyThumbnails[index]);
                }
            });
            
            if (imageFiles.length > emptyThumbnails.length) {
                const unplacedCount = imageFiles.length - emptyThumbnails.length;
                alert(`${unplacedCount}Êûö„ÅÆÁîªÂÉè„ÅØÁ©∫„Åç„Çπ„Éö„Éº„Çπ„Åå„Å™„ÅÑ„Åü„ÇÅÈÖçÁΩÆ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü`);
            }
        }

        // „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ„ÅÆÂàùÊúüÂåñ
        function initializeCustomFields() {
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                const row7Input = document.getElementById(`customRow7-${plan}`);
                const row8Input = document.getElementById(`customRow8-${plan}`);
                
                if (row7Input) {
                    row7Input.addEventListener('input', function() {
                        customFields[plan].row7Right = this.value;
                    });
                }
                
                if (row8Input) {
                    row8Input.addEventListener('input', function() {
                        customFields[plan].row8Right = this.value;
                    });
                }
            });
        }

        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆËá™Âãï„É™„Çµ„Ç§„Ç∫
        function initializeTextareaAutoResize() {
            const textareas = document.querySelectorAll('.patient-info-input, .free-text-area, .multi-line-input, .ng-text-input, .guide-textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
        }

        // ‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ
        function bulkUploadIntraoral() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*';
            
            input.onchange = (event) => {
                const files = Array.from(event.target.files);
                if (files.length > 5) {
                    alert('5Êûö„Åæ„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const positions = ['upper', 'right', 'front', 'left', 'lower'];
                files.forEach((file, index) => {
                    if (index < positions.length) {
                        const thumbnail = document.querySelector(`[data-type="intraoral"][data-position="${positions[index]}"]`);
                        if (thumbnail) {
                            handleImageUpload(file, thumbnail);
                        }
                    }
                });
            };
            
            input.click();
        }

        function bulkUploadDental10() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*';
            
            input.onchange = (event) => {
                const files = Array.from(event.target.files);
                if (files.length > 10) {
                    alert('10Êûö„Åæ„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                files.forEach((file, index) => {
                    if (index < 10) {
                        const position = `10-${index + 1}`;
                        const thumbnail = document.querySelector(`[data-type="xray"][data-position="${position}"]`);
                        if (thumbnail) {
                            handleImageUpload(file, thumbnail);
                        }
                    }
                });
            };
            
            input.click();
        }

        // Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function setViewMode(mode) {
            currentViewMode = mode;
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (mode === 'single') {
                document.getElementById('single-view').style.display = 'block';
                document.getElementById('split-view').style.display = 'none';
            } else {
                document.getElementById('single-view').style.display = 'none';
                document.getElementById('split-view').style.display = 'grid';
                updateSplitView();
            }
        }

        // ÂàÜÂâ≤Ë°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateSplitView() {
            const intraoralContainer = document.getElementById('split-intraoral');
            const xrayContainer = document.getElementById('split-xray');
            
            intraoralContainer.innerHTML = '';
            const intraoralThumbnails = document.querySelectorAll('#intraoral-thumbnails .thumbnail');
            intraoralThumbnails.forEach(thumb => {
                if (thumb.classList.contains('has-image')) {
                    const clone = thumb.cloneNode(true);
                    setupImageControls(clone);
                    intraoralContainer.appendChild(clone);
                }
            });
            
            xrayContainer.innerHTML = '';
            const xrayThumbnails = document.querySelectorAll('#xray-thumbnails .thumbnail, .dental-10 .thumbnail');
            xrayThumbnails.forEach(thumb => {
                if (thumb.classList.contains('has-image')) {
                    const clone = thumb.cloneNode(true);
                    setupImageControls(clone);
                    xrayContainer.appendChild(clone);
                }
            });
        }

        // ÁîªÂÉè„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupImageControls(thumbnail) {
            const controls = thumbnail.querySelector('.image-controls');
            if (controls) {
                const buttons = controls.querySelectorAll('.image-control-btn');
                buttons.forEach(btn => {
                    if (btn.classList.contains('delete')) {
                        btn.onclick = (e) => deleteImage(e, btn);
                    } else if (btn.title === '‰∏ä‰∏ãÂèçËª¢') {
                        btn.onclick = (e) => flipImageVertical(e, btn);
                    } else if (btn.title === 'Â∑¶Âè≥ÂèçËª¢') {
                        btn.onclick = (e) => flipImageHorizontal(e, btn);
                    } else if (btn.title === '90Â∫¶ÂõûËª¢') {
                        btn.onclick = (e) => rotateImage(e, btn);
                    }
                });
            }
            
            thumbnail.addEventListener('click', handleThumbnailClick);
            
            thumbnail.addEventListener('dragstart', handleImageDragStart);
            thumbnail.addEventListener('dragend', handleImageDragEnd);
            thumbnail.addEventListener('dragover', handleImageDragOver);
            thumbnail.addEventListener('drop', handleImageDrop);
            thumbnail.addEventListener('dragleave', handleImageDragLeave);
        }

        // ÁîªÂÉèÂ§âÂΩ¢Èñ¢Êï∞
        function getImageTransformKey(thumbnail) {
            const type = thumbnail.dataset.type;
            const position = thumbnail.dataset.position;
            return `${type}-${position}`;
        }

        function applyImageTransform(img, transformKey) {
            if (!imageTransforms[transformKey]) {
                imageTransforms[transformKey] = {
                    flipH: false,
                    flipV: false,
                    rotation: 0
                };
            }
            
            const transform = imageTransforms[transformKey];
            let transformStr = '';
            
            if (transform.flipH) transformStr += 'scaleX(-1) ';
            if (transform.flipV) transformStr += 'scaleY(-1) ';
            if (transform.rotation) transformStr += `rotate(${transform.rotation}deg) ';
            
            img.style.transform = transformStr;
        }

        // ‰∏ä‰∏ãÂèçËª¢
        function flipImageVertical(event, button) {
            event.stopPropagation();
            const thumbnail = button.closest('.thumbnail');
            const img = thumbnail.querySelector('img');
            if (!img) return;
            
            const key = getImageTransformKey(thumbnail);
            if (!imageTransforms[key]) {
                imageTransforms[key] = { flipH: false, flipV: false, rotation: 0 };
            }
            
            imageTransforms[key].flipV = !imageTransforms[key].flipV;
            applyImageTransform(img, key);
            
            if (currentViewMode === 'split') {
                updateSplitView();
            }
        }

        // Â∑¶Âè≥ÂèçËª¢
        function flipImageHorizontal(event, button) {
            event.stopPropagation();
            const thumbnail = button.closest('.thumbnail');
            const img = thumbnail.querySelector('img');
            if (!img) return;
            
            const key = getImageTransformKey(thumbnail);
            if (!imageTransforms[key]) {
                imageTransforms[key] = { flipH: false, flipV: false, rotation: 0 };
            }
            
            imageTransforms[key].flipH = !imageTransforms[key].flipH;
            applyImageTransform(img, key);
            
            if (currentViewMode === 'split') {
                updateSplitView();
            }
        }

        // 90Â∫¶ÂõûËª¢
        function rotateImage(event, button) {
            event.stopPropagation();
            const thumbnail = button.closest('.thumbnail');
            const img = thumbnail.querySelector('img');
            if (!img) return;
            
            const key = getImageTransformKey(thumbnail);
            if (!imageTransforms[key]) {
                imageTransforms[key] = { flipH: false, flipV: false, rotation: 0 };
            }
            
            imageTransforms[key].rotation = (imageTransforms[key].rotation + 90) % 360;
            applyImageTransform(img, key);
            
            if (currentViewMode === 'split') {
                updateSplitView();
            }
        }

        // ÂàÜÂâ≤ÁîªÈù¢„ÅÆÂàùÊúüÂåñ
        function initializeSplitPane() {
            const divider = document.querySelector('.split-divider');
            const leftPanel = document.querySelector('.left-panel');
            const container = document.querySelector('.main-container');
            let isDragging = false;

            divider.addEventListener('mousedown', (e) => {
                isDragging = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const containerRect = container.getBoundingClientRect();
                const newWidth = e.clientX - containerRect.left;
                const percentage = (newWidth / containerRect.width) * 100;
                
                if (percentage > 20 && percentage < 80) {
                    leftPanel.style.width = percentage + '%';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
        function initializeDragAndDrop() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('dragover', handleDragOver);
                thumbnail.addEventListener('drop', handleDrop);
                thumbnail.addEventListener('dragleave', handleDragLeave);
                thumbnail.addEventListener('click', handleThumbnailClick);
            });

            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', (e) => e.preventDefault());
        }

        // Âñ´ÁÖôÈÅ∏Êäû„ÅÆÂàùÊúüÂåñ
        function initializeSmokingToggle() {
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                const smokingRadios = document.querySelectorAll(`input[name="smoking-${plan}"]`);
                const smokingAmount = document.getElementById(`smokingAmount-${plan}`);
                
                smokingRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'Êúâ') {
                            smokingAmount.style.display = 'inline-block';
                        } else {
                            smokingAmount.style.display = 'none';
                            smokingAmount.value = '';
                        }
                    });
                });
            });
        }

        // „Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„ÉºÂá¶ÁêÜ
        function handleDragOver(e) {
            e.preventDefault();
            
            if (!draggedThumbnail) {
                this.classList.add('drag-over');
            }
        }

        // „Éâ„É©„ÉÉ„Ç∞„É™„Éº„ÉñÂá¶ÁêÜ
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        // „Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedThumbnail) {
                return;
            }
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageUpload(files[0], this);
            }
        }

        // „Çµ„É†„Éç„Ç§„É´„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleThumbnailClick(e) {
            if (e.target.classList.contains('image-control-btn')) {
                return;
            }
            
            if (!this.classList.contains('has-image')) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = (event) => {
                    if (event.target.files.length > 0) {
                        handleImageUpload(event.target.files[0], this);
                    }
                };
                
                input.click();
            } else {
                const img = this.querySelector('img');
                if (img) {
                    showLargeImage(img.src, getImageTransformKey(this));
                }
            }
        }

        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        function handleImageUpload(file, thumbnail) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                const existingImg = thumbnail.querySelector('img');
                if (existingImg) {
                    existingImg.remove();
                }
                
                const img = document.createElement('img');
                img.src = imageData;
                img.draggable = false;
                thumbnail.appendChild(img);
                thumbnail.classList.add('has-image');
                thumbnail.draggable = true;
                
                const key = getImageTransformKey(thumbnail);
                if (imageTransforms[key]) {
                    applyImageTransform(img, key);
                }
                
                const type = thumbnail.dataset.type;
                const position = thumbnail.dataset.position;
                if (!uploadedImages[type]) {
                    uploadedImages[type] = {};
                }
                uploadedImages[type][position] = imageData;
                
                showLargeImage(imageData, key);
                
                if (currentViewMode === 'split') {
                    updateSplitView();
                }
                
                initializeImageDragAndDrop();
            };
            
            reader.readAsDataURL(file);
        }

        // ÁîªÂÉèÂâäÈô§
        function deleteImage(event, button) {
            event.stopPropagation();
            const thumbnail = button.closest('.thumbnail');
            const img = thumbnail.querySelector('img');
            
            if (img) {
                img.remove();
                thumbnail.classList.remove('has-image');
                thumbnail.draggable = false;
                
                const type = thumbnail.dataset.type;
                const position = thumbnail.dataset.position;
                if (uploadedImages[type] && uploadedImages[type][position]) {
                    delete uploadedImages[type][position];
                }
                
                const key = getImageTransformKey(thumbnail);
                delete imageTransforms[key];
                
                const largeImageContainer = document.getElementById('largeImageContainer');
                if (largeImageContainer.querySelector('img')?.src === img.src) {
                    largeImageContainer.innerHTML = '<p style="color: #999;">ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                }
                
                if (currentViewMode === 'split') {
                    updateSplitView();
                }
            }
        }

        // Â§ß„Åç„ÅÑÁîªÂÉèË°®Á§∫
        function showLargeImage(imageSrc, transformKey) {
            const container = document.getElementById('largeImageContainer');
            const img = document.createElement('img');
            img.className = 'large-image';
            img.src = imageSrc;
            
            if (transformKey && imageTransforms[transformKey]) {
                applyImageTransform(img, transformKey);
            }
            
            container.innerHTML = '';
            container.appendChild(img);
        }

        // ÂåªÁÆ°„Éú„Çø„É≥„ÅÆ„Éà„Ç∞„É´
        function toggleMedicalBtn(type, plan) {
            const btn = document.getElementById(`btn-${type}-${plan}`);
            btn.classList.toggle('selected');
            
            if (btn.classList.contains('selected')) {
                if (!medicalManagement[plan].includes(type === 'soui' ? 'Á∑èÂåª' : 'ÂåªÁÆ°')) {
                    medicalManagement[plan].push(type === 'soui' ? 'Á∑èÂåª' : 'ÂåªÁÆ°');
                }
            } else {
                const index = medicalManagement[plan].indexOf(type === 'soui' ? 'Á∑èÂåª' : 'ÂåªÁÆ°');
                if (index > -1) {
                    medicalManagement[plan].splice(index, 1);
                }
            }
        }

        // ÈÅ∏Êäû„Ç™„Éó„Ç∑„Éß„É≥
        function selectOption(field, value, plan) {
            document.querySelectorAll(`#plan-${plan} [data-field="${field}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            remarksData[plan][field] = value;
        }

        // Ê≠ØÂºèÈÅ∏Êäû
        function selectField(fieldName, plan) {
            if (activeField) {
                document.getElementById(`field-${activeField}-${plan}`).classList.remove('active');
            }
            
            activeField = fieldName;
            document.getElementById(`field-${fieldName}-${plan}`).classList.add('active');
            
            if (fieldName === 'customRow7') {
                const customName = document.getElementById(`customRow7-${plan}`).value || '„Ç´„Çπ„Çø„É†È†ÖÁõÆ7';
                document.getElementById(`currentSelection-${plan}`).textContent = `ÁèæÂú®ÈÅ∏Êäû‰∏≠: ${customName}`;
            } else if (fieldName === 'customRow8') {
                const customName = document.getElementById(`customRow8-${plan}`).value || '„Ç´„Çπ„Çø„É†È†ÖÁõÆ8';
                document.getElementById(`currentSelection-${plan}`).textContent = `ÁèæÂú®ÈÅ∏Êäû‰∏≠: ${customName}`;
            } else {
                document.getElementById(`currentSelection-${plan}`).textContent = `ÁèæÂú®ÈÅ∏Êäû‰∏≠: ${fieldName}`;
            }
            
            updateToothSelection(plan);
        }

        function selectTooth(position, number, plan) {
            if (!activeField) {
                alert('ÂÖà„Å´Ê≤ªÁôÇÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!selectedTeeth[plan][activeField]) {
                selectedTeeth[plan][activeField] = [];
            }
            
            const index = selectedTeeth[plan][activeField].findIndex(t => 
                t.position === position && t.number === number
            );
            
            if (index > -1) {
                selectedTeeth[plan][activeField].splice(index, 1);
            } else {
                selectedTeeth[plan][activeField].push({ position, number });
            }
            
            updateToothSelection(plan);
            updateFieldDisplay(activeField, plan);
        }

        function updateToothSelection(plan) {
            document.querySelectorAll(`#plan-${plan} .tooth-btn`).forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (activeField && selectedTeeth[plan][activeField]) {
                selectedTeeth[plan][activeField].forEach(tooth => {
                    const btn = document.querySelector(`#plan-${plan} [data-position="${tooth.position}"][data-number="${tooth.number}"]`);
                    if (btn) btn.classList.add('selected');
                });
            }
        }

        function updateFieldDisplay(fieldName, plan) {
            const field = document.getElementById(`field-${fieldName}-${plan}`);
            field.innerHTML = '';
            
            if (!selectedTeeth[plan][fieldName] || selectedTeeth[plan][fieldName].length === 0) {
                return;
            }
            
            const grouped = {};
            selectedTeeth[plan][fieldName].forEach(tooth => {
                if (!grouped[tooth.position]) {
                    grouped[tooth.position] = [];
                }
                grouped[tooth.position].push(tooth.number);
            });
            
            const crossDisplay = document.createElement('div');
            crossDisplay.className = 'cross-display';
            
            const quadrantMap = {
                'Âè≥‰∏ä': 'top-left',
                'Â∑¶‰∏ä': 'top-right',
                'Âè≥‰∏ã': 'bottom-left',
                'Â∑¶‰∏ã': 'bottom-right'
            };
            
            Object.entries(grouped).forEach(([position, numbers]) => {
                const quadrantClass = quadrantMap[position];
                const quadrant = document.createElement('div');
                quadrant.className = `quadrant ${quadrantClass}`;
                
                if (position === 'Âè≥‰∏ä' || position === 'Âè≥‰∏ã') {
                    numbers.sort((a, b) => b - a);
                } else {
                    numbers.sort((a, b) => a - b);
                }
                
                quadrant.textContent = numbers.join(' ');
                crossDisplay.appendChild(quadrant);
            });
            
            field.appendChild(crossDisplay);
        }

        // Ê≤ªÁôÇÈ†ÜÂ∫è„ÅÆ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
        let draggedItem = null;

        function initializeDraggableOrder(item) {
            item.draggable = true;
            
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            item.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(this.parentElement, e.clientY);
                if (afterElement == null) {
                    this.parentElement.appendChild(draggedItem);
                } else {
                    this.parentElement.insertBefore(draggedItem, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.treatment-order-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Ê≤ªÁôÇÈ†ÜÂ∫è„ÅÆËá™ÂãïÁîüÊàê
        function autoGenerateTreatmentOrder(plan) {
            const orderList = document.getElementById(`treatmentOrderList-${plan}`);
            orderList.innerHTML = '';
            treatmentOrderCounter[plan] = 0;

            const treatments = [];
            for (let treatment in selectedTeeth[plan]) {
                if (selectedTeeth[plan][treatment] && selectedTeeth[plan][treatment].length > 0) {
                    const teeth = selectedTeeth[plan][treatment].map(t => `${t.position}${t.number}`).join(', ');
                    
                    let treatmentName = treatment;
                    if (treatment === 'customRow7') {
                        treatmentName = document.getElementById(`customRow7-${plan}`).value || '„Ç´„Çπ„Çø„É†È†ÖÁõÆ7';
                    } else if (treatment === 'customRow8') {
                        treatmentName = document.getElementById(`customRow8-${plan}`).value || '„Ç´„Çπ„Çø„É†È†ÖÁõÆ8';
                    }
                    
                    treatments.push({
                        treatment: treatmentName,
                        teeth: teeth,
                        priority: treatmentPriority[treatment] || 99
                    });
                }
            }

            treatments.sort((a, b) => a.priority - b.priority);

            treatments.forEach(item => {
                addTreatmentOrder(plan, item.treatment, item.teeth);
            });

            if (treatments.length === 0) {
                alert('Ê≤ªÁôÇË®àÁîª„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂÖà„Å´Ê≤ªÁôÇÈ†ÖÁõÆ„Å®Ê≠ØÂºè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                addTreatmentOrder(plan);
            }

            updateOrderNumbers(plan);
        }

        // Ê≤ªÁôÇÈ†ÜÂ∫è„ÅÆËøΩÂä†
        function addTreatmentOrder(plan, presetTreatment = '', presetTeeth = '') {
            treatmentOrderCounter[plan]++;
            const orderList = document.getElementById(`treatmentOrderList-${plan}`);
            
            const orderItem = document.createElement('div');
            orderItem.className = 'treatment-order-item';
            orderItem.id = `order-${plan}-${treatmentOrderCounter[plan]}`;
            
            let optionsHtml = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            treatmentOptions.forEach(option => {
                const selected = option === presetTreatment ? 'selected' : '';
                optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
            });
            
            const customRow7Name = document.getElementById(`customRow7-${plan}`)?.value;
            const customRow8Name = document.getElementById(`customRow8-${plan}`)?.value;
            if (customRow7Name) {
                const selected = customRow7Name === presetTreatment ? 'selected' : '';
                optionsHtml += `<option value="${customRow7Name}" ${selected}>${customRow7Name}</option>`;
            }
            if (customRow8Name) {
                const selected = customRow8Name === presetTreatment ? 'selected' : '';
                optionsHtml += `<option value="${customRow8Name}" ${selected}>${customRow8Name}</option>`;
            }
            
            orderItem.innerHTML = `
                <div class="drag-handle">‚â°</div>
                <div class="order-number">1</div>
                <select class="treatment-select">
                    ${optionsHtml}
                </select>
                <input type="text" class="teeth-input" placeholder="‰æã: Âè≥‰∏ä6, Â∑¶‰∏ã4-5" value="${presetTeeth}">
                <input type="text" class="notes-input" placeholder="ÂÇôËÄÉ">
                <button class="delete-order-btn" onclick="deleteTreatmentOrder('order-${plan}-${treatmentOrderCounter[plan]}', '${plan}')">ÂâäÈô§</button>
            `;
            
            orderList.appendChild(orderItem);
            initializeDraggableOrder(orderItem);
            updateOrderNumbers(plan);
        }

        function deleteTreatmentOrder(orderId, plan) {
            const orderItem = document.getElementById(orderId);
            if (orderItem) {
                orderItem.remove();
                updateOrderNumbers(plan);
            }
        }

        function updateOrderNumbers(plan) {
            const orderItems = document.querySelectorAll(`#treatmentOrderList-${plan} .treatment-order-item`);
            orderItems.forEach((item, index) => {
                const numberDiv = item.querySelector('.order-number');
                if (numberDiv) {
                    numberDiv.textContent = index + 1;
                }
            });
        }

        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        function clearCurrentField(plan) {
            if (!activeField) {
                alert('„ÇØ„É™„Ç¢„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (confirm(`${activeField}„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü`)) {
                selectedTeeth[plan][activeField] = [];
                updateFieldDisplay(activeField, plan);
                updateToothSelection(plan);
            }
        }

        function clearAll() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                document.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(input => {
                    input.value = '';
                });
                
                const today = new Date().toISOString().split('T')[0];
                ['ideal', 'standard', 'insurance'].forEach(plan => {
                    const dateInput = document.getElementById(`planDate-${plan}`);
                    if (dateInput) {
                        dateInput.value = today;
                    }
                });
                
                ['ideal', 'standard', 'insurance'].forEach(plan => {
                    document.querySelector(`input[name="smoking-${plan}"][value="ÁÑ°"]`)?.setAttribute('checked', true);
                    const smokingAmount = document.getElementById(`smokingAmount-${plan}`);
                    if (smokingAmount) {
                        smokingAmount.style.display = 'none';
                    }
                });
                
                document.querySelectorAll('.select-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.medical-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                selectedTeeth = {
                    ideal: {},
                    standard: {},
                    insurance: {}
                };
                document.querySelectorAll('.treatment-field').forEach(field => {
                    field.innerHTML = '';
                    field.classList.remove('active');
                });
                document.querySelectorAll('.tooth-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                uploadedImages = {};
                imageTransforms = {};
                document.querySelectorAll('.thumbnail').forEach(thumbnail => {
                    const img = thumbnail.querySelector('img');
                    if (img) img.remove();
                    thumbnail.classList.remove('has-image');
                    thumbnail.draggable = false;
                });
                document.getElementById('largeImageContainer').innerHTML = '<p style="color: #999;">ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                
                ['ideal', 'standard', 'insurance'].forEach(plan => {
                    const orderList = document.getElementById(`treatmentOrderList-${plan}`);
                    if (orderList) {
                        orderList.innerHTML = '';
                    }
                    treatmentOrderCounter[plan] = 0;
                    addTreatmentOrder(plan);
                });
                
                activeField = null;
                medicalManagement = {
                    ideal: [],
                    standard: [],
                    insurance: []
                };
                remarksData = {
                    ideal: {},
                    standard: {},
                    insurance: {}
                };
                customFields = {
                    ideal: {},
                    standard: {},
                    insurance: {}
                };
                planningGuideData = {
                    patientBackground: {},
                    extractionTeeth: [],
                    prognosisTeeth: [],
                    occlusionIssues: {},
                    occlusionClass: '',
                    insurancePlan: {},
                    orthodontics: {},
                    implantPlan: {},
                    futureRisk: {},
                    selfPayOptions: {},
                    longTermPrognosis: {},
                    patientCommunication: {}
                };
                
                ['ideal', 'standard', 'insurance'].forEach(plan => {
                    const selection = document.getElementById(`currentSelection-${plan}`);
                    if (selection) {
                        selection.textContent = 'Ê≤ªÁôÇÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    }
                });
                
                document.querySelectorAll('textarea').forEach(textarea => {
                    textarea.style.height = 'auto';
                });
                
                updateProgress();
            }
        }

        // „Éá„Éº„ÇøÂèéÈõÜ
        function collectRemarksData(plan) {
            const smokingRadio = document.querySelector(`input[name="smoking-${plan}"]:checked`);
            const remarks = {
                smoking: smokingRadio ? smokingRadio.value : 'ÁÑ°',
                smokingAmount: document.getElementById(`smokingAmount-${plan}`)?.value || '',
                occlusion: document.getElementById(`occlusion-${plan}`)?.value || '',
                brx: remarksData[plan].brx || '',
                ng: remarksData[plan].ng || '',
                ngText: document.getElementById(`ngText-${plan}`)?.value || '',
                p: remarksData[plan].p || '',
                c: remarksData[plan].c || '',
                ortho: remarksData[plan].ortho || '',
                clearTools: document.getElementById(`clearTools-${plan}`)?.value || '',
                ohiPolicy: document.getElementById(`ohiPolicy-${plan}`)?.value || '',
                notes: document.getElementById(`remarksNotes-${plan}`)?.value || ''
            };
            return remarks;
        }

        // „Éá„Éº„Çø‰øùÂ≠ò
        function saveData() {
            const patientInfo = {
                name: document.getElementById('patientName').value,
                id: document.getElementById('patientId').value
            };
            
            if (!patientInfo.name || !patientInfo.id) {
                alert('ÊÇ£ËÄÖÂêç„Å®ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const plans = {};
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                const chiefComplaint = document.getElementById(`chiefComplaint-${plan}`)?.value || '';
                const medicalHistory = document.getElementById(`medicalHistory-${plan}`)?.value || '';
                const medications = document.getElementById(`medications-${plan}`)?.value || '';
                const precautions = document.getElementById(`precautions-${plan}`)?.value || '';
                
                const treatmentPlan = {
                    date: document.getElementById(`planDate-${plan}`)?.value || '',
                    doctorName: document.getElementById(`planDoctorName-${plan}`)?.value || '',
                    dhName: document.getElementById(`planDhName-${plan}`)?.value || '',
                    medicalManagement: medicalManagement[plan] || []
                };
                
                const treatmentOrder = [];
                document.querySelectorAll(`#treatmentOrderList-${plan} .treatment-order-item`).forEach(item => {
                    const treatment = item.querySelector('.treatment-select').value;
                    const teeth = item.querySelector('.teeth-input').value;
                    const notes = item.querySelector('.notes-input').value;
                    
                    if (treatment) {
                        treatmentOrder.push({ treatment, teeth, notes });
                    }
                });
                
                plans[plan] = {
                    patientInfo: {
                        chiefComplaint,
                        medicalHistory,
                        medications,
                        precautions
                    },
                    treatmentPlan,
                    treatments: selectedTeeth[plan] || {},
                    freeText: document.getElementById(`freeText-${plan}`)?.value || '',
                    treatmentOrder,
                    remarks: collectRemarksData(plan),
                    customFields: customFields[plan] || {}
                };
            });
            
            const data = {
                patientInfo,
                patientName: patientInfo.name,
                patientId: patientInfo.id,
                plans,
                images: uploadedImages,
                imageTransforms: imageTransforms,
                planningGuide: planningGuideData,
                activePlan,
                date: new Date().toLocaleDateString('ja-JP')
            };
            
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';
                    if (result.success) {
                        alert(result.message);
                    } else {
                        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                })
                .saveToTempFolder(data);
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showLoadModal() {
            document.getElementById('loadModal').style.display = 'block';
            loadFileList();
        }

        function closeLoadModal() {
            document.getElementById('loadModal').style.display = 'none';
        }

        // „Éï„Ç°„Ç§„É´„É™„Çπ„ÉàË™≠„ÅøËæº„Åø
        function loadFileList() {
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(fileList) {
                    document.getElementById('loading').style.display = 'none';
                    const container = document.getElementById('fileList');
                    
                    if (fileList.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999;">‰øùÂ≠òÊ∏à„Åø„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                        return;
                    }
                    
                    let html = '';
                    fileList.forEach(file => {
                        const date = new Date(file.timestamp.replace(/-/g, ':')).toLocaleString('ja-JP');
                        html += `
                            <div class="file-item">
                                <div class="file-item-info">
                                    <strong>${file.patientName}</strong> (ID: ${file.patientId})<br>
                                    <small>‰øùÂ≠òÊó•ÊôÇ: ${date}</small>
                                </div>
                                <div class="file-item-actions">
                                    <button class="btn btn-primary" onclick="loadData('${file.id}')">Ë™≠„ÅøËæº„Åø</button>
                                    <button class="btn btn-danger" onclick="deleteFile('${file.id}')">ÂâäÈô§</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Éï„Ç°„Ç§„É´„É™„Çπ„ÉàÂèñÂæó„Ç®„É©„Éº: ' + error);
                })
                .getTempFileList();
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        function loadData(fileId) {
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';
                    if (result.success) {
                        const data = result.data;
                        
                        // ÊÇ£ËÄÖÂü∫Êú¨ÊÉÖÂ†±„ÇíÂæ©ÂÖÉ
                        if (data.patientInfo) {
                            document.getElementById('patientName').value = data.patientInfo.name || '';
                            document.getElementById('patientId').value = data.patientInfo.id || '';
                        }
                        
                        // ÂêÑ„Éó„É©„É≥„ÅÆ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
                        if (data.plans) {
                            Object.keys(data.plans).forEach(plan => {
                                const planData = data.plans[plan];
                                
                                // ÊÇ£ËÄÖÊÉÖÂ†±
                                if (planData.patientInfo) {
                                    document.getElementById(`chiefComplaint-${plan}`).value = planData.patientInfo.chiefComplaint || '';
                                    document.getElementById(`medicalHistory-${plan}`).value = planData.patientInfo.medicalHistory || '';
                                    document.getElementById(`medications-${plan}`).value = planData.patientInfo.medications || '';
                                    document.getElementById(`precautions-${plan}`).value = planData.patientInfo.precautions || '';
                                }
                                
                                // Ê≤ªÁôÇË®àÁîª„Éò„ÉÉ„ÉÄ„Éº
                                if (planData.treatmentPlan) {
                                    document.getElementById(`planDate-${plan}`).value = planData.treatmentPlan.date || '';
                                    document.getElementById(`planDoctorName-${plan}`).value = planData.treatmentPlan.doctorName || '';
                                    document.getElementById(`planDhName-${plan}`).value = planData.treatmentPlan.dhName || '';
                                    
                                    medicalManagement[plan] = planData.treatmentPlan.medicalManagement || [];
                                    document.querySelectorAll(`#plan-${plan} .medical-btn`).forEach(btn => {
                                        btn.classList.remove('selected');
                                    });
                                    medicalManagement[plan].forEach(item => {
                                        if (item === 'Á∑èÂåª') {
                                            document.getElementById(`btn-soui-${plan}`)?.classList.add('selected');
                                        } else if (item === 'ÂåªÁÆ°') {
                                            document.getElementById(`btn-ikan-${plan}`)?.classList.add('selected');
                                        }
                                    });
                                }
                                
                                // „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ
                                if (planData.customFields) {
                                    customFields[plan] = planData.customFields;
                                    if (planData.customFields.row7Right) {
                                        const input = document.getElementById(`customRow7-${plan}`);
                                        if (input) input.value = planData.customFields.row7Right;
                                    }
                                    if (planData.customFields.row8Right) {
                                        const input = document.getElementById(`customRow8-${plan}`);
                                        if (input) input.value = planData.customFields.row8Right;
                                    }
                                }
                                
                                // ÂÇôËÄÉÊ¨Ñ
                                if (planData.remarks) {
                                    if (planData.remarks.smoking) {
                                        const radio = document.querySelector(`input[name="smoking-${plan}"][value="${planData.remarks.smoking}"]`);
                                        if (radio) radio.checked = true;
                                        if (planData.remarks.smoking === 'Êúâ' && planData.remarks.smokingAmount) {
                                            const amountInput = document.getElementById(`smokingAmount-${plan}`);
                                            if (amountInput) {
                                                amountInput.style.display = 'inline-block';
                                                amountInput.value = planData.remarks.smokingAmount;
                                            }
                                        }
                                    }
                                    
                                    const fields = ['occlusion', 'ngText', 'clearTools', 'ohiPolicy', 'notes'];
                                    fields.forEach(field => {
                                        const input = document.getElementById(`${field === 'notes' ? 'remarksNotes' : field}-${plan}`);
                                        if (input && planData.remarks[field]) {
                                            input.value = planData.remarks[field];
                                        }
                                    });
                                    
                                    remarksData[plan] = {};
                                    ['brx', 'ng', 'p', 'c', 'ortho'].forEach(field => {
                                        if (planData.remarks[field]) {
                                            remarksData[plan][field] = planData.remarks[field];
                                            const btn = document.querySelector(`#plan-${plan} [data-field="${field}"][data-value="${planData.remarks[field]}"]`);
                                            if (btn) btn.classList.add('selected');
                                        }
                                    });
                                }
                                
                                // Ê≤ªÁôÇ„Éá„Éº„Çø
                                selectedTeeth[plan] = planData.treatments || {};
                                const freeText = document.getElementById(`freeText-${plan}`);
                                if (freeText) freeText.value = planData.freeText || '';
                                
                                // Ê≤ªÁôÇÈ†ÜÂ∫è
                                if (planData.treatmentOrder && planData.treatmentOrder.length > 0) {
                                    const orderList = document.getElementById(`treatmentOrderList-${plan}`);
                                    if (orderList) {
                                        orderList.innerHTML = '';
                                        treatmentOrderCounter[plan] = 0;
                                        
                                        planData.treatmentOrder.forEach(order => {
                                            addTreatmentOrder(plan, order.treatment, order.teeth);
                                            const lastItem = orderList.querySelector('.treatment-order-item:last-child');
                                            if (lastItem && order.notes) {
                                                lastItem.querySelector('.notes-input').value = order.notes;
                                            }
                                        });
                                    }
                                }
                                
                                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                                Object.keys(selectedTeeth[plan]).forEach(fieldName => {
                                    updateFieldDisplay(fieldName, plan);
                                });
                            });
                        }
                        
                        // ÁîªÂÉè„ÇíÂæ©ÂÖÉ
                        if (data.images) {
                            uploadedImages = data.images;
                            imageTransforms = data.imageTransforms || {};
                            
                            for (let type in data.images) {
                                for (let position in data.images[type]) {
                                    const thumbnail = document.querySelector(`[data-type="${type}"][data-position="${position}"]`);
                                    if (thumbnail) {
                                        const img = document.createElement('img');
                                        img.src = data.images[type][position];
                                        img.draggable = false;
                                        thumbnail.appendChild(img);
                                        thumbnail.classList.add('has-image');
                                        thumbnail.draggable = true;
                                        
                                        const key = `${type}-${position}`;
                                        if (imageTransforms[key]) {
                                            applyImageTransform(img, key);
                                        }
                                    }
                                }
                            }
                            
                            initializeImageDragAndDrop();
                        }
                        
                        // Á´ãÊ°à„Ç¨„Ç§„Éâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
                        if (data.planningGuide) {
                            planningGuideData = data.planningGuide;
                            // „Ç¨„Ç§„Éâ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÂÆüË£ÖÁúÅÁï•Ôºâ
                        }
                        
                        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É©„É≥„ÇíÂæ©ÂÖÉ
                        if (data.activePlan) {
                            activePlan = data.activePlan;
                            switchPlanTab(activePlan);
                        }
                        
                        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíË™øÊï¥
                        document.querySelectorAll('textarea').forEach(textarea => {
                            textarea.style.height = 'auto';
                            textarea.style.height = (textarea.scrollHeight) + 'px';
                        });
                        
                        closeLoadModal();
                        alert('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                    } else {
                        alert('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                })
                .loadTempFile(fileId);
        }

        // „Éï„Ç°„Ç§„É´ÂâäÈô§
        function deleteFile(fileId) {
            if (confirm('„Åì„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                document.getElementById('loading').style.display = 'flex';
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        document.getElementById('loading').style.display = 'none';
                        if (result.success) {
                            alert(result.message);
                            loadFileList();
                        } else {
                            alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        document.getElementById('loading').style.display = 'none';
                        alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                    })
                    .deleteTempFile(fileId);
            }
        }

        // PDFÁîüÊàê
        function generatePDF() {
            const patientInfo = {
                name: document.getElementById('patientName').value,
                id: document.getElementById('patientId').value
            };
            
            if (!patientInfo.name) {
                alert('ÊÇ£ËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÁèæÂú®„ÅÆ„Éó„É©„É≥„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
            const planData = collectPlanData(activePlan);
            
            const data = {
                patientInfo: {
                    ...patientInfo,
                    ...planData.patientInfo
                },
                treatmentPlan: planData.treatmentPlan,
                treatments: planData.treatments,
                treatmentOrder: planData.treatmentOrder,
                freeText: planData.freeText,
                remarks: planData.remarks,
                customFields: planData.customFields,
                selectedPlan: getPlanDisplayName(activePlan),
                planningGuide: planningGuideData,
                date: new Date().toLocaleDateString('ja-JP')
            };
            
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';
                    if (result.success) {
                        if (confirm('PDF„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü')) {
                            window.open(result.url, '_blank');
                        }
                    } else {
                        alert('PDFÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                })
                .generatePDF(data);
        }

        // „Éó„É©„É≥„Éá„Éº„Çø„ÅÆÂèéÈõÜ
        function collectPlanData(plan) {
            const patientInfo = {
                chiefComplaint: document.getElementById(`chiefComplaint-${plan}`)?.value || '',
                medicalHistory: document.getElementById(`medicalHistory-${plan}`)?.value || '',
                medications: document.getElementById(`medications-${plan}`)?.value || '',
                precautions: document.getElementById(`precautions-${plan}`)?.value || ''
            };
            
            const treatmentPlan = {
                date: document.getElementById(`planDate-${plan}`)?.value || '',
                doctorName: document.getElementById(`planDoctorName-${plan}`)?.value || '',
                dhName: document.getElementById(`planDhName-${plan}`)?.value || '',
                medicalManagement: medicalManagement[plan] || []
            };
            
            const treatmentOrder = [];
            document.querySelectorAll(`#treatmentOrderList-${plan} .treatment-order-item`).forEach(item => {
                const treatment = item.querySelector('.treatment-select').value;
                const teeth = item.querySelector('.teeth-input').value;
                const notes = item.querySelector('.notes-input').value;
                
                if (treatment) {
                    treatmentOrder.push({ treatment, teeth, notes });
                }
            });
            
            return {
                patientInfo,
                treatmentPlan,
                treatments: selectedTeeth[plan] || {},
                freeText: document.getElementById(`freeText-${plan}`)?.value || '',
                treatmentOrder,
                remarks: collectRemarksData(plan),
                customFields: customFields[plan] || {}
            };
        }

        // Ê≤ªÁôÇË®àÁîª„ÅÆ„Åø„ÅÆPDFÁîüÊàê
        function generateTreatmentOnlyPDF() {
            const patientInfo = {
                name: document.getElementById('patientName').value,
                id: document.getElementById('patientId').value
            };
            
            if (!patientInfo.name) {
                alert('ÊÇ£ËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const planData = collectPlanData(activePlan);
            
            const data = {
                patientInfo,
                treatmentPlan: planData.treatmentPlan,
                treatments: planData.treatments,
                freeText: planData.freeText,
                remarks: planData.remarks,
                customFields: planData.customFields,
                selectedPlan: getPlanDisplayName(activePlan),
                date: new Date().toLocaleDateString('ja-JP')
            };
            
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';
                    if (result.success) {
                        if (confirm('Ê≤ªÁôÇË®àÁîªPDF„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü')) {
                            window.open(result.url, '_blank');
                        }
                    } else {
                        alert('PDFÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                })
                .generateTreatmentOnlyPDF(data);
        }

        // „Éó„É©„É≥ÊØîËºÉPDFÁîüÊàê
        function generateComparisonPDF() {
            const patientInfo = {
                name: document.getElementById('patientName').value,
                id: document.getElementById('patientId').value
            };
            
            if (!patientInfo.name) {
                alert('ÊÇ£ËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const plans = {};
            ['ideal', 'standard', 'insurance'].forEach(plan => {
                plans[plan] = collectPlanData(plan);
            });
            
            const data = {
                patientInfo,
                plans,
                date: new Date().toLocaleDateString('ja-JP')
            };
            
            document.getElementById('loading').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';
                    if (result.success) {
                        if (confirm('„Éó„É©„É≥ÊØîËºÉPDF„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü')) {
                            window.open(result.url, '_blank');
                        }
                    } else {
                        alert('PDFÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
                })
                .generateComparisonPDF(data);
        }

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
            if (event.target.classList.contains('tooth-selection-modal')) {
                event.target.style.display = 'none';
            }
        }

        // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøú
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', function() {}, {passive: true});
        }

        // „Éâ„É©„ÉÉ„Ç∞ÈÅ∏ÊäûÊ©üËÉΩ„ÅÆËøΩÂä†
        let isDraggingTeeth = false;
        let dragStartTooth = null;

        // Ê≠ØÂºèÈÅ∏Êäû„ÅÆÊã°ÂºµÊ©üËÉΩ„ÇíÂàùÊúüÂåñ
        function initializeAdvancedToothSelection() {
            const toothButtons = document.querySelectorAll('.tooth-btn');
            
            toothButtons.forEach(btn => {
                btn.addEventListener('mousedown', function(e) {
                    if (!activeField) {
                        alert('ÂÖà„Å´Ê≤ªÁôÇÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                        return;
                    }
                    e.preventDefault();
                    isDraggingTeeth = true;
                    dragStartTooth = this;
                    
                    const position = this.dataset.position;
                    const number = parseInt(this.dataset.number);
                    const plan = this.closest('.plan-content')?.id.replace('plan-', '') || activePlan;
                    toggleToothSelection(position, number, plan);
                });
                
                btn.addEventListener('mouseenter', function() {
                    if (isDraggingTeeth && activeField) {
                        const position = this.dataset.position;
                        const number = parseInt(this.dataset.number);
                        const plan = this.closest('.plan-content')?.id.replace('plan-', '') || activePlan;
                        
                        if (dragStartTooth && dragStartTooth.dataset.position === position) {
                            const startNum = parseInt(dragStartTooth.dataset.number);
                            const endNum = number;
                            const minNum = Math.min(startNum, endNum);
                            const maxNum = Math.max(startNum, endNum);
                            
                            for (let i = minNum; i <= maxNum; i++) {
                                addToothToSelection(position, i, plan);
                            }
                            updateToothSelection(plan);
                            updateFieldDisplay(activeField, plan);
                        }
                    }
                });
                
                btn.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    if (!activeField) return;
                    
                    const position = this.dataset.position;
                    const number = parseInt(this.dataset.number);
                    const plan = this.closest('.plan-content')?.id.replace('plan-', '') || activePlan;
                    
                    for (let i = Math.max(1, number - 1); i <= Math.min(8, number + 1); i++) {
                        addToothToSelection(position, i, plan);
                    }
                    updateToothSelection(plan);
                    updateFieldDisplay(activeField, plan);
                });
            });
            
            document.addEventListener('mouseup', function() {
                isDraggingTeeth = false;
                dragStartTooth = null;
            });
            
            let lastSelectedTooth = null;
            
            toothButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (!activeField) return;
                    
                    const position = this.dataset.position;
                    const number = parseInt(this.dataset.number);
                    const plan = this.closest('.plan-content')?.id.replace('plan-', '') || activePlan;
                    
                    if (e.shiftKey && lastSelectedTooth && lastSelectedTooth.position === position) {
                        e.preventDefault();
                        const startNum = lastSelectedTooth.number;
                        const endNum = number;
                        const minNum = Math.min(startNum, endNum);
                        const maxNum = Math.max(startNum, endNum);
                        
                        for (let i = minNum; i <= maxNum; i++) {
                            addToothToSelection(position, i, plan);
                        }
                        updateToothSelection(plan);
                        updateFieldDisplay(activeField, plan);
                    } else {
                        lastSelectedTooth = { position, number };
                    }
                });
            });
        }

        // Ê≠Ø„ÇíÈÅ∏Êäû„Å´ËøΩÂä†ÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
        function addToothToSelection(position, number, plan) {
            if (!selectedTeeth[plan][activeField]) {
                selectedTeeth[plan][activeField] = [];
            }
            
            const exists = selectedTeeth[plan][activeField].some(t => 
                t.position === position && t.number === number
            );
            
            if (!exists) {
                selectedTeeth[plan][activeField].push({ position, number });
            }
        }

        // Ê≠Ø„ÅÆÈÅ∏Êäû„Çí„Éà„Ç∞„É´
        function toggleToothSelection(position, number, plan) {
            if (!selectedTeeth[plan][activeField]) {
                selectedTeeth[plan][activeField] = [];
            }
            
            const index = selectedTeeth[plan][activeField].findIndex(t => 
                t.position === position && t.number === number
            );
            
            if (index > -1) {
                selectedTeeth[plan][activeField].splice(index, 1);
            } else {
                selectedTeeth[plan][activeField].push({ position, number });
            }
        }
    </script>
</body>
</html>